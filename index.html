<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شات العزاوي - تطبيق دردشة متكامل</title>
    
    <!-- START: FIREBASE SDK (Using Modular v9+ with compat for easier transition) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <!-- END: FIREBASE SDK -->

    <style>
        /* All your existing CSS styles go here. */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%  ); min-height: 100vh; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        @media (min-width: 768px) { .container { padding: 20px; } }
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 20px; }
        @media (min-width: 768px) { .card { padding: 24px; } }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        @media (min-width: 768px) { .btn { padding: 12px 24px; font-size: 16px; } }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-google { background-color: #4285F4; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-google:hover { background-color: #357ae8; }
        .room-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        .room-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            transition: transform 0.3s ease-in-out;
        }
        .room-card:hover img {
            transform: scale(1.05);
        }
        @media (min-width: 768px) { .room-card img { height: 200px; } }
        .room-card-content {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .room-card-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .room-card-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            flex-grow: 1;
        }
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        @media (min-width: 768px) {
            .rooms-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .message { 
            padding: 12px 16px; 
            border-radius: 12px; 
            margin-bottom: 12px; 
            max-width: 85%; 
            animation: slideIn 0.3s ease-out; 
            word-wrap: break-word; 
            position: relative;
            clear: both;
        }
        @media (min-width: 768px) { .message { max-width: 70%; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-sent { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            margin-left: auto; 
            margin-right: 0;
            float: right;
        }
        .message-received { 
            background: #f3f4f6; 
            color: #1f2937; 
            margin-right: auto; 
            margin-left: 0;
            float: left;
        }
        .message-admin { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); 
            color: white; 
            margin-right: auto; 
            position: relative; 
            animation: fireGlow 2s ease-in-out infinite; 
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5); 
            float: left;
        }
        @keyframes fireGlow { 0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.5); } 50% { box-shadow: 0 0 30px rgba(255, 107, 107, 0.8), 0 0 40px rgba(238, 90, 36, 0.6); } }
        .message-admin::before { content: '🔥'; position: absolute; top: -10px; right: -10px; font-size: 20px; animation: fireFloat 1.5s ease-in-out infinite; }
        @keyframes fireFloat { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-5px) rotate(10deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 10px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        @media (min-width: 768px) { .modal-content { padding: 32px; } }
        .input-field { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; margin-bottom: 16px; transition: border-color 0.3s; }
        .input-field:focus { outline: none; border-color: #667eea; }
        .ads-banner-container { width: 100%; overflow: hidden; background-color: #f8f8f8; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; height: 40px; }
        .ads-banner { display: flex; align-items: center; white-space: nowrap; position: absolute; top: 0; left: 0; height: 100%; animation: scrollAds 30s linear infinite; }
        .ads-banner-item { padding: 0 20px; font-size: 1.1em; color: #333; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .ads-banner-item::before { content: '📢'; font-size: 1.2em; }
        .ads-separator { width: 2px; height: 70%; background-color: #ccc; margin: 0 15px; }
        @keyframes scrollAds { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        @media (min-width: 768px) { .stat-card { padding: 24px; } }
        .tab-button { padding: 10px 16px; border: none; background: transparent; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; transition: all 0.3s; font-size: 14px; }
        @media (min-width: 768px) { .tab-button { padding: 12px 24px; font-size: 16px; } }
        .tab-button.active { border-bottom-color: #667eea; color: #667eea; }
        .hidden { display: none !important; }
        .grid { display: grid; gap: 15px; }
        @media (min-width: 768px) { .grid { gap: 20px; } }
        .grid-cols-4 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        @media (min-width: 768px) { .grid-cols-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } }
        .main-header { background: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/%D9%85%D9%84%D8%A7%D8%B0-%D8%A7%D9%84%D8%B0%D9%87%D8%A8%D9%8A3-%D8%A7%D9%84%D9%85%D8%AA%D8%AD%D8%B1%D9%83-1-tkGUJkQJVKQoTmRIFbMFUpI8gCzfkJ.gif'  ) center/cover; padding: 16px 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); position: relative; }
        .main-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.85); border-radius: 16px; z-index: 0; }
        .main-header > * { position: relative; z-index: 1; }
        @media (min-width: 768px) { .main-header { padding: 20px 32px; } }
        .header-title { font-size: 28px; font-weight: 900; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: titlePulse 3s ease-in-out infinite; text-align: center; margin-bottom: 16px; }
        @media (min-width: 768px) { .header-title { font-size: 36px; margin-bottom: 0; text-align: right; } }
        @keyframes titlePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .nav-links { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
        @media (min-width: 768px) { .nav-links { gap: 20px; justify-content: flex-start; } }
        .nav-link { padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s; animation: navFloat 3s ease-in-out infinite; text-decoration: none; display: inline-block; }
        @media (min-width: 768px) { .nav-link { padding: 10px 20px; font-size: 14px; } }
        .nav-link:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .header { background: white; padding: 12px 16px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex-wrap: wrap; gap: 10px; }
        @media (min-width: 768px) { .header { padding: 16px 24px; flex-wrap: nowrap; } }
        .chat-container { display: flex; flex-direction: column; height: 100vh; background: white; border-radius: 0; overflow: hidden; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; }
        @media (min-width: 768px) { .chat-container { height: calc(100vh - 40px); position: relative; border-radius: 16px; margin: 20px auto; max-width: 1400px; } }
        .messages-container { flex: 1; overflow-y: auto; padding: 15px; display: block; padding-bottom: 120px; min-height: 0; }
        @media (min-width: 768px) { .messages-container { padding: 20px; padding-bottom: 100px; } }
        .message-input-container { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; border-top: 2px solid #e5e7eb; display: flex; gap: 8px; background: white; z-index: 101; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        @media (min-width: 768px) { .message-input-container { padding: 15px; gap: 12px; position: absolute; border-radius: 0 0 16px 16px; } }
        .emoji-picker { display: none; position: absolute; bottom: 70px; right: 15px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 10px; z-index: 102; max-height: 200px; overflow-y: auto; }
        .emoji-picker.active { display: block; }
        .emoji-grid { display: flex; flex-wrap: wrap; gap: 5px; }
        .emoji-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px; transition: transform 0.1s; }
        .emoji-btn:hover { transform: scale(1.1); }
        .profile-btn { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid #667eea; object-fit: cover; }
        .coins-display { background: #ffd700; color: #8b4513; padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 4px; }
        .admin-notification { background: #ff6b6b; color: white; padding: 10px; text-align: center; font-weight: bold; border-radius: 8px; margin: 10px 0; }
        .user-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .admin-badge { background: #ff6b6b; color: white; }
        .moderator-badge { background: #ffd700; color: #8b4513; }
        .user-badge-default { background: #e5e7eb; color: #374151; }
        .user-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
        .user-list-item:last-child { border-bottom: none; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-actions button { margin-left: 8px; }
        .profile-modal { max-width: 600px; }
        .profile-header { text-align: center; margin-bottom: 24px; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 16px; border: 4px solid #667eea; }
        .profile-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin: 24px 0; }
        .stat-item { text-align: center; padding: 16px; background: #f9fafb; border-radius: 12px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 14px; color: #6b7280; margin-top: 4px; }
        .private-message-btn { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #8b4513; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 16px; }
        .private-message-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4); }
        .private-message-btn:disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
        .hidden-room { position: relative; }
        .hidden-room::before { content: '🔒'; position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; z-index: 1; }
        .notification { position: fixed; top: 20px; left: 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); z-index: 2000; animation: slideInLeft 0.3s ease-out; max-width: 300px; }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.error { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .file-upload { position: relative; display: inline-block; }
        .file-upload input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-upload-btn { background: #667eea; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; display: inline-block; transition: all 0.3s; }
        .file-upload-btn:hover { background: #5a67d8; transform: translateY(-2px); }
        .messages-container::after { content: ""; display: table; clear: both; }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal active">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 24px; font-size: 28px; font-weight: bold; color: #667eea;">مرحباً بك في شات العزاوي</h2>
            <div style="text-align: center; margin-bottom: 24px;">
                <button onclick="loginWithGoogle()" class="btn btn-google" style="width: 100%; margin-bottom: 16px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    تسجيل الدخول بـ Google
                </button>
            </div>
            <div class="divider">أو</div>
            <input type="email" id="emailInput" placeholder="البريد الإلكتروني" class="input-field">
            <input type="password" id="passwordInput" placeholder="كلمة المرور" class="input-field">
            <div style="display: flex; gap: 12px;">
                <button onclick="loginWithEmail()" class="btn btn-primary" style="flex: 1;">تسجيل الدخول</button>
                <button onclick="registerWithEmail()" class="btn btn-success" style="flex: 1;">إنشاء حساب</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="container hidden">

        <!-- Main Header -->
        <div class="main-header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <h1 class="header-title">شات العزاوي</h1>
                <div class="nav-links">
                    <a href="#" class="nav-link" onclick="showRooms()">الغرف</a>
                    <a href="#" class="nav-link" onclick="showProfile()">الملف الشخصي</a>
                    <a href="#" class="nav-link" onclick="showPrivateMessages()">الرسائل الخاصة</a>
                    <a href="#" class="nav-link" onclick="showAdminContactModal()">راسل الإدارة</a>
                    <a href="#" class="nav-link hidden" id="adminBtn" onclick="showAdmin()">الإدارة</a>
                </div>
            </div>
        </div>

        <div id="ads-banner-container" class="ads-banner-container hidden">
            <div id="ads-banner" class="ads-banner"></div>
        </div>

        <!-- Main Views Container -->
        <div id="viewsContainer">
            <!-- Rooms View -->
            <div id="roomsView" class="hidden">
                <div class="card">
                    <h2 class="title-section" style="margin-bottom: 24px; text-align: center;">الغرف المتاحة</h2>
                    <div id="roomsGrid" class="rooms-grid"></div>
                </div>
            </div>

            <!-- Chat View -->
            <div id="chatView" class="chat-container hidden">
                <div class="header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button onclick="goBack()" class="btn btn-primary">→ رجوع</button>
                        <div>
                            <h3 id="chatRoomName" class="title-main"></h3>
                            <p id="chatRoomDesc" class="hidden" style="color: #6b7280; font-size: 14px;"></p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img id="userAvatarBtn2" class="profile-btn hidden" onclick="showProfile()">
                        <span id="userNameDisplay2" style="font-weight: 600;"></span>
                        <div id="userCoinsDisplay2" class="coins-display hidden">
                            <span id="userCoinsCount2">0</span> 🪙
                        </div>
                         <button onclick="logout()" class="btn btn-danger">تسجيل الخروج</button>
                    </div>
                </div>
                
                <div id="adminNotificationContainer"></div>
                
                <div class="messages-container" id="messagesContainer"></div>
                
                <div class="message-input-container">
                    <button onclick="toggleEmojiPicker()" class="btn btn-primary">😊</button>
                    <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا..." style="flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                    <button onclick="sendMessage()" class="btn btn-primary">إرسال</button>
                </div>
                
                <div id="emojiPicker" class="emoji-picker">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="hidden">
                <div class="card">
                    <h2 class="title-section" style="margin-bottom: 24px; text-align: center;">لوحة الإدارة</h2>
                    
                    <div class="grid grid-cols-4" style="margin-bottom: 32px;">
                        <div class="stat-card"><h3 id="totalUsers" style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">0</h3><p>إجمالي المستخدمين</p></div>
                        <div class="stat-card"><h3 id="onlineUsers" style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">0</h3><p>المتصلون الآن</p></div>
                        <div class="stat-card"><h3 id="totalRooms" style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">0</h3><p>إجمالي الغرف</p></div>
                        <div class="stat-card"><h3 id="totalMessages" style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">0</h3><p>إجمالي الرسائل</p></div>
                    </div>

                    <div class="tab-buttons" style="display: flex; justify-content: center; margin-bottom: 24px;">
                        <button class="tab-button active" onclick="switchAdminTab('users')">إدارة المستخدمين</button>
                        <button class="tab-button" onclick="switchAdminTab('rooms')">إدارة الغرف</button>
                        <button class="tab-button" onclick="switchAdminTab('ads')">إدارة الإعلانات</button>
                    </div>

                    <div id="adminUsersTab">
                        <h3 style="margin-bottom: 16px;">قائمة المستخدمين</h3>
                        <div id="userList"></div>
                    </div>

                    <div id="adminRoomsTab" class="hidden">
                        <h3 style="margin-bottom: 16px;">قائمة الغرف</h3>
                        <div id="roomList"></div>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="showCreateRoomModal()">إنشاء غرفة جديدة</button>
                    </div>

                    <div id="adminAdsTab" class="hidden">
                        <h3 style="margin-bottom: 16px;">إدارة الإعلانات</h3>
                        <input type="text" id="newAdInput" placeholder="نص الإعلان الجديد" class="input-field">
                        <button class="btn btn-primary" onclick="addAd()">إضافة إعلان</button>
                        <div id="ads-list" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="modal">
                <div class="modal-content profile-modal">
                    <button onclick="closeModal('profileView')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    <div class="profile-header">
                        <img id="profileAvatar" class="profile-avatar" src="https://via.placeholder.com/100" alt="Avatar">
                        <h2 id="profileName" style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">اسم المستخدم</h2>
                        <p id="profileEmail" style="color: #6b7280; margin-bottom: 8px;">البريد الإلكتروني</p>
                        <span id="profileRole" class="user-badge user-badge-default">عضو</span>
                    </div>

                    <div class="profile-stats">
                        <div class="stat-item">
                            <div id="profileCoins" class="stat-value">0</div>
                            <div class="stat-label">عملة</div>
                        </div>
                        <div class="stat-item">
                            <div id="profileMessages" class="stat-value">0</div>
                            <div class="stat-label">رسالة</div>
                        </div>
                        <div class="stat-item">
                            <div id="profileJoinDate" class="stat-value">--</div>
                            <div class="stat-label">تاريخ الانضمام</div>
                        </div>
                    </div>

                    <div id="profileEditSection" class="hidden">
                        <h3 style="margin-bottom: 16px;">تعديل الملف الشخصي</h3>
                        <input type="text" id="profileNameEdit" placeholder="الاسم" class="input-field">
                        <textarea id="profileBio" placeholder="نبذة عني" class="input-field" rows="3"></textarea>
                        <h4 style="margin-bottom: 8px;">اختر صورة رمزية:</h4>
                        <div id="avatarOptions" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
                            <!-- Avatars will be injected here -->
                        </div>
                        <button onclick="updateProfile()" class="btn btn-primary" style="width: 100%;">حفظ التعديلات</button>
                    </div>

                    <div id="profileActionsSection" style="text-align: center;">
                        <button id="editProfileBtn" onclick="toggleProfileEdit()" class="btn btn-primary" style="margin-top: 16px;">تعديل الملف الشخصي</button>
                        <button id="privateMessageBtn" class="private-message-btn hidden" onclick="startPrivateChat()">إرسال رسالة خاصة</button>
                        <button id="adminActionsBtn" class="btn btn-danger hidden" onclick="showAdminActionsModal()">إجراءات المدير</button>
                    </div>
                </div>
            </div>

            <!-- Private Messages View -->
            <div id="privateMessagesView" class="hidden">
                <div class="card">
                    <h2 class="title-section" style="margin-bottom: 24px; text-align: center;">الرسائل الخاصة</h2>
                    <div id="privateChatsList"></div>
                </div>
            </div>

            <!-- Private Chat View -->
            <div id="privateChatView" class="chat-container hidden">
                <div class="header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button onclick="goBackToPrivateChats()" class="btn btn-primary">→ رجوع</button>
                        <div>
                            <h3 id="privateChatUserName" class="title-main"></h3>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                         <button onclick="logout()" class="btn btn-danger">تسجيل الخروج</button>
                    </div>
                </div>
                
                <div class="messages-container" id="privateMessagesContainer"></div>
                
                <div class="message-input-container">
                    <input type="text" id="privateMessageInput" placeholder="اكتب رسالتك الخاصة هنا..." style="flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                    <button onclick="sendPrivateMessage()" class="btn btn-primary">إرسال</button>
                </div>
            </div>

            <!-- Create Room Modal -->
            <div id="createRoomModal" class="modal">
                <div class="modal-content">
                    <button onclick="closeModal('createRoomModal')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    <h2 style="text-align: center; margin-bottom: 24px;">إنشاء غرفة جديدة</h2>
                    <input type="text" id="newRoomName" placeholder="اسم الغرفة" class="input-field">
                    <textarea id="newRoomDescription" placeholder="وصف الغرفة" class="input-field" rows="3"></textarea>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="newRoomIsHidden"> غرفة خاصة (مخفية)
                    </label>
                    <button onclick="createRoom()" class="btn btn-primary" style="width: 100%;">إنشاء</button>
                </div>
            </div>

            <!-- Admin Actions Modal -->
            <div id="adminActionsModal" class="modal">
                <div class="modal-content">
                    <button onclick="closeModal('adminActionsModal')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    <h2 style="text-align: center; margin-bottom: 24px;">إجراءات المدير على <span id="adminActionUserName"></span></h2>
                    <div id="adminActionsContent">
                        <button id="banUserBtn" class="btn btn-danger" style="width: 100%; margin-bottom: 10px;" onclick="banUser()">حظر المستخدم</button>
                        <button id="unbanUserBtn" class="btn btn-success hidden" style="width: 100%; margin-bottom: 10px;" onclick="unbanUser()">إلغاء حظر المستخدم</button>
                        <button id="promoteToModBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="promoteUser('moderator')">ترقية إلى مشرف</button>
                        <button id="demoteFromModBtn" class="btn btn-danger hidden" style="width: 100%; margin-bottom: 10px;" onclick="promoteUser('user')">تخفيض من مشرف</button>
                        <button id="promoteToAdminBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="promoteUser('admin')">ترقية إلى مدير</button>
                        <button id="demoteFromAdminBtn" class="btn btn-danger hidden" style="width: 100%; margin-bottom: 10px;" onclick="promoteUser('user')">تخفيض من مدير</button>
                    </div>
                </div>
            </div>

            <!-- Admin Contact Modal -->
            <div id="adminContactModal" class="modal">
                <div class="modal-content">
                    <button onclick="closeModal('adminContactModal')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    <h2 style="text-align: center; margin-bottom: 24px;">راسل الإدارة</h2>
                    <textarea id="adminContactMessage" placeholder="اكتب رسالتك للإدارة هنا..." class="input-field" rows="5"></textarea>
                    <button onclick="sendAdminContactMessage()" class="btn btn-primary" style="width: 100%;">إرسال الرسالة</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // =================================================================
        // FIREBASE CONFIGURATION & INITIALIZATION
        // =================================================================
        
        // ** تم دمج إعدادات Firebase الجديدة هنا **
        const firebaseConfig = {
            apiKey: "AIzaSyAyn2M8LGYpCFFMY1jsZzc80f0H9mVvh6Q",
            authDomain: "chate-2d1d1.firebaseapp.com",
            projectId: "chate-2d1d1",
            storageBucket: "chate-2d1d1.firebasestorage.app",
            messagingSenderId: "34207834349",
            appId: "1:34207834349:web:3c4c5971f3131ca1536ce4",
            measurementId: "G-SKTRYF395G"
        };

        // Initialize Firebase App
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
        const storage = app.storage();

        // Global state variables
        let currentUser = null;
        let currentRoom = null;
        let messagesListener = null;
        let privateMessagesListener = null;
        let currentPrivateChatId = null;
        let currentProfileUserId = null;
        let currentAdminActionUserId = null;
        let currentAdminActionUserData = null;

        // =================================================================
        // AUTHENTICATION
        // =================================================================

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await handleUserLogin(user);
            } else {
                handleUserLogout();
            }
        });

        async function handleUserLogin(user) {
            try {
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();

                if (!userDoc.exists) {
                    // New user registration
                    currentUser = {
                        id: user.uid,
                        name: user.displayName || 'مستخدم جديد',
                        email: user.email,
                        avatar: user.photoURL || 'https://via.placeholder.com/100',
                        role: 'user',
                        coins: 0,
                        messageCount: 0,
                        bio: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        isBanned: false,
                        blockedUsers: []
                    };
                    await userRef.set(currentUser);
                } else {
                    currentUser = { id: user.uid, ...userDoc.data() };
                    // Update last login time and online status
                    await userRef.update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        isOnline: true
                    });
                }

                // Ensure currentUser has necessary fields
                currentUser.blockedUsers = currentUser.blockedUsers || [];
                currentUser.isBanned = currentUser.isBanned || false;
                
                if (currentUser.isBanned) {
                    alert('تم حظرك من استخدام هذا التطبيق.');
                    await auth.signOut();
                    return;
                }

                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('mainContainer').classList.remove('hidden');
                
                updateHeaderUI();
                showRooms();
                initializeEmojiPicker();
                listenForNotifications();
                listenForAds();
                
                if (currentUser.role === 'admin') {
                    document.getElementById('adminBtn').classList.remove('hidden');
                    showAdminNotification();
                }

            } catch (error) {
                console.error("Error handling user login:", error);
                showNotification('حدث خطأ أثناء تسجيل الدخول. حاول مرة أخرى.', 'error');
                await auth.signOut();
            }
        }

        function handleUserLogout() {
            currentUser = null;
            currentRoom = null;
            if (messagesListener) messagesListener();
            if (privateMessagesListener) privateMessagesListener();
            
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('adminBtn').classList.add('hidden');
        }

        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error("Google login error:", error);
                showNotification('فشل تسجيل الدخول بـ Google: ' + error.message, 'error');
            }
        }

        async function loginWithEmail() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error("Email login error:", error);
                showNotification('فشل تسجيل الدخول: ' + error.message, 'error');
            }
        }

        async function registerWithEmail() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                // The handleUserLogin will take care of the rest
            } catch (error) {
                console.error("Email registration error:", error);
                showNotification('فشل إنشاء الحساب: ' + error.message, 'error');
            }
        }

        async function logout() {
            try {
                if (currentUser) {
                    await db.collection('users').doc(currentUser.id).update({
                        isOnline: false
                    });
                }
                await auth.signOut();
            } catch (error) {
                console.error("Logout error:", error);
                showNotification('فشل تسجيل الخروج: ' + error.message, 'error');
            }
        }

        // =================================================================
        // UI MANAGEMENT
        // =================================================================

        function updateHeaderUI() {
            if (currentUser) {
                document.getElementById('userNameDisplay2').textContent = currentUser.name;
                document.getElementById('userAvatarBtn2').src = currentUser.avatar;
                document.getElementById('userAvatarBtn2').classList.remove('hidden');
                document.getElementById('userCoinsCount2').textContent = currentUser.coins || 0;
                document.getElementById('userCoinsDisplay2').classList.remove('hidden');
            }
        }

        function showRooms() {
            document.getElementById('roomsView').classList.remove('hidden');
            document.getElementById('chatView').classList.add('hidden');
            document.getElementById('adminView').classList.add('hidden');
            document.getElementById('privateMessagesView').classList.add('hidden');
            document.getElementById('privateChatView').classList.add('hidden');
            
            if (messagesListener) {
                messagesListener();
                messagesListener = null;
            }
            currentRoom = null;
            renderRooms();
        }

        function showChat(room) {
            currentRoom = room;
            document.getElementById('roomsView').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('chatRoomName').textContent = room.name;
            document.getElementById('chatRoomDesc').textContent = room.description;
            document.getElementById('messagesContainer').innerHTML = '';
            
            renderMessages();
        }

        function goBack() {
            showRooms();
        }

        function showAdmin() {
            if (currentUser.role !== 'admin') return;
            document.getElementById('roomsView').classList.add('hidden');
            document.getElementById('chatView').classList.add('hidden');
            document.getElementById('adminView').classList.remove('hidden');
            document.getElementById('privateMessagesView').classList.add('hidden');
            document.getElementById('privateChatView').classList.add('hidden');
            
            if (messagesListener) {
                messagesListener();
                messagesListener = null;
            }
            currentRoom = null;
            
            renderAdminDashboard();
            switchAdminTab('users');
        }

        function switchAdminTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminUsersTab').classList.add('hidden');
            document.getElementById('adminRoomsTab').classList.add('hidden');
            document.getElementById('adminAdsTab').classList.add('hidden');

            if (tabName === 'users') {
                document.querySelector('.tab-button:nth-child(1)').classList.add('active');
                document.getElementById('adminUsersTab').classList.remove('hidden');
                renderUserList();
            } else if (tabName === 'rooms') {
                document.querySelector('.tab-button:nth-child(2)').classList.add('active');
                document.getElementById('adminRoomsTab').classList.remove('hidden');
                renderAdminRoomList();
            } else if (tabName === 'ads') {
                document.querySelector('.tab-button:nth-child(3)').classList.add('active');
                document.getElementById('adminAdsTab').classList.remove('hidden');
                renderAdsManagement();
            }
        }

        function showCreateRoomModal() {
            document.getElementById('createRoomModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // =================================================================
        // ROOMS MANAGEMENT
        // =================================================================

        async function renderRooms() {
            const roomsGrid = document.getElementById('roomsGrid');
            roomsGrid.innerHTML = 'جاري تحميل الغرف...';
            
            try {
                const snapshot = await db.collection('rooms').orderBy('createdAt', 'asc').get();
                const rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                roomsGrid.innerHTML = rooms.filter(room => !room.isHidden || currentUser.role === 'admin').map(room => `
                    <div class="room-card ${room.isHidden ? 'hidden-room' : ''}" onclick="showChat({ id: '${room.id}', name: '${room.name}', description: '${room.description}' })">
                        <img src="${room.image || 'https://via.placeholder.com/300x200'}" alt="${room.name}">
                        <div class="room-card-content">
                            <div>
                                <div class="room-card-title">${room.name}</div>
                                <div class="room-card-description">${room.description}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #9ca3af;">
                                <span>💬 ${room.messageCount || 0} رسالة</span>
                                <span>👥 ${room.onlineUsers || 0} متصل</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                if (rooms.length === 0) {
                    roomsGrid.innerHTML = '<p style="text-align: center; color: #6b7280;">لا توجد غرف متاحة حالياً.</p>';
                }

            } catch (error) {
                console.error("Error rendering rooms:", error);
                roomsGrid.innerHTML = '<p style="text-align: center; color: #ef4444;">فشل تحميل الغرف.</p>';
            }
        }

        async function createRoom() {
            const name = document.getElementById('newRoomName').value.trim();
            const description = document.getElementById('newRoomDescription').value.trim();
            const isHidden = document.getElementById('newRoomIsHidden').checked;

            if (!name || !description) {
                return showNotification('الرجاء إدخال اسم ووصف للغرفة.', 'error');
            }

            try {
                await db.collection('rooms').add({
                    name,
                    description,
                    isHidden,
                    image: 'https://via.placeholder.com/300x200', // Default image
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    messageCount: 0,
                    onlineUsers: 0
                });
                
                showNotification('تم إنشاء الغرفة بنجاح!');
                closeModal('createRoomModal');
                renderRooms();
                renderAdminRoomList();

            } catch (error) {
                console.error("Error creating room:", error);
                showNotification('فشل إنشاء الغرفة.', 'error');
            }
        }

        // =================================================================
        // CHAT MESSAGES
        // =================================================================

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentRoom || !currentUser) return;
            
            input.value = ''; // Clear input immediately
            
            try {
                const messageData = {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userAvatar: currentUser.avatar,
                    role: currentUser.role,
                    content: content,
                    likes: [],
                    likesCount: 0,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('rooms').doc(currentRoom.id).collection('messages').add(messageData);
                
                await db.collection('rooms').doc(currentRoom.id).update({
                    messageCount: firebase.firestore.FieldValue.increment(1)
                });
                
                await db.collection('users').doc(currentUser.id).update({
                    messageCount: firebase.firestore.FieldValue.increment(1)
                });
                currentUser.messageCount = (currentUser.messageCount || 0) + 1;
                
            } catch (error) {
                console.error("Error sending message: ", error);
                input.value = content;
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            if (!currentRoom) return;
            if (messagesListener) messagesListener();

            messagesListener = db.collection('rooms').doc(currentRoom.id).collection('messages')
                .orderBy('timestamp', 'asc')
                .limitToLast(100)
                .onSnapshot(snapshot => {
                    container.innerHTML = snapshot.docs.map(doc => {
                        const msg = { id: doc.id, ...doc.data() };
                        const isSent = msg.userId === currentUser.id;
                        
                        if (currentUser.blockedUsers && currentUser.blockedUsers.includes(msg.userId) && !isSent) {
                            return '';
                        }

                        let messageClass = isSent ? 'message-sent' : 'message-received';
                        if (msg.role === 'admin') messageClass = 'message-admin';
                        
                        const roleIcon = msg.role === 'admin' ? '👑' : msg.role === 'moderator' ? '⭐' : '';
                        const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : '';
                        
                        const displayName = isSent ? currentUser.name : msg.userName;
                        const displayAvatar = isSent ? currentUser.avatar : msg.userAvatar;
                        
                        const userLiked = msg.likes && msg.likes.includes(currentUser.id);
                        
                        return `
                            <div class="message ${messageClass}">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <img src="${displayAvatar}" class="profile-btn" style="width: 24px; height: 24px;" onclick="showUserProfile('${msg.userId}')">
                                    <strong style="font-size: 14px; cursor: pointer;" onclick="showUserProfile('${msg.userId}')">${displayName}</strong>
                                    ${roleIcon ? `<span style="font-size: 12px;">${roleIcon}</span>` : ''}
                                </div>
                                <div>${msg.content.replace(/\n/g, '<br>')}</div>
                                <div class="message-actions">
                                    <button class="like-btn ${userLiked ? 'liked' : ''}" onclick="toggleLike('${msg.id}')">
                                        ❤️ ${msg.likesCount || 0}
                                    </button>
                                    <button class="quote-btn" onclick="quoteMessage('${msg.content}', '${displayName}')">
                                        💬 اقتباس
                                    </button>
                                </div>
                                <div style="font-size: 12px; opacity: 0.7; margin-top: 4px; text-align: left;">${timestamp}</div>
                                ${!isSent ? `
                                    <div class="message-options">
                                        <button class="options-btn" onclick="toggleMessageOptions(event, '${msg.userId}', '${displayName}')">⋯</button>
                                    </div>
                                ` : ''}
                                ${currentUser.role === 'admin' ? `
                                    <div style="position: absolute; top: 5px; right: 5px;">
                                        <button onclick="adminDeleteMessage(currentRoom.id, '${msg.id}')" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer;">حذف</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    container.scrollTop = container.scrollHeight;
                }, error => console.error("Error fetching messages: ", error));
        }

        async function toggleLike(messageId) {
            if (!currentRoom || !currentUser) return;
            const messageRef = db.collection('rooms').doc(currentRoom.id).collection('messages').doc(messageId);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const messageDoc = await transaction.get(messageRef);
                    if (!messageDoc.exists) return;
                    
                    const messageData = messageDoc.data();
                    const likes = messageData.likes || [];
                    const userLiked = likes.includes(currentUser.id);
                    
                    if (userLiked) {
                        transaction.update(messageRef, {
                            likes: firebase.firestore.FieldValue.arrayRemove(currentUser.id),
                            likesCount: firebase.firestore.FieldValue.increment(-1)
                        });
                    } else {
                        transaction.update(messageRef, {
                            likes: firebase.firestore.FieldValue.arrayUnion(currentUser.id),
                            likesCount: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                });
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        function quoteMessage(content, userName) {
            const input = document.getElementById('messageInput');
            const quotedText = `> "${content.substring(0, 50)}..." - ${userName}\n\n`;
            input.value = quotedText + input.value;
            input.focus();
        }

        // =================================================================
        // PROFILE MANAGEMENT
        // =================================================================

        function showProfile() {
            showUserProfile(currentUser.id);
        }

        async function showUserProfile(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) return alert('المستخدم غير موجود');
                
                const userData = userDoc.data();
                currentProfileUserId = userId;
                
                document.getElementById('profileAvatar').src = userData.avatar;
                document.getElementById('profileName').textContent = userData.name;
                document.getElementById('profileEmail').textContent = userData.email;
                document.getElementById('profileRole').textContent = getRoleText(userData.role);
                document.getElementById('profileRole').className = `user-badge ${getRoleClass(userData.role)}`;
                document.getElementById('profileCoins').textContent = userData.coins || 0;
                document.getElementById('profileMessages').textContent = userData.messageCount || 0;
                document.getElementById('profileJoinDate').textContent = userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleDateString('ar-SA') : '-';
                
                const isCurrentUser = userId === currentUser.id;
                document.getElementById('profileBio').value = userData.bio || '';
                document.getElementById('profileNameEdit').value = userData.name;

                // Toggle edit section visibility
                document.getElementById('profileEditSection').classList.toggle('hidden', !isCurrentUser);
                document.getElementById('editProfileBtn').classList.toggle('hidden', !isCurrentUser);
                
                // Toggle private message button
                const privateMessageBtn = document.getElementById('privateMessageBtn');
                privateMessageBtn.classList.toggle('hidden', isCurrentUser);
                if (!isCurrentUser) {
                    privateMessageBtn.onclick = () => startPrivateChat(userId, userData.name, userData.avatar);
                }

                // Toggle admin actions button
                const adminActionsBtn = document.getElementById('adminActionsBtn');
                const isAdmin = currentUser.role === 'admin';
                adminActionsBtn.classList.toggle('hidden', !isAdmin || isCurrentUser);
                if (isAdmin && !isCurrentUser) {
                    adminActionsBtn.onclick = () => showAdminActionsModal(userId, userData);
                }

                renderAvatarOptions(userData.avatar);
                document.getElementById('profileView').classList.add('active');

            } catch (error) {
                console.error("Error showing user profile:", error);
                showNotification('فشل عرض الملف الشخصي.', 'error');
            }
        }

        function toggleProfileEdit() {
            const editSection = document.getElementById('profileEditSection');
            editSection.classList.toggle('hidden');
        }

        function renderAvatarOptions(currentAvatar) {
            const avatars = [
                'https://via.placeholder.com/100/FF5733/FFFFFF?text=A1',
                'https://via.placeholder.com/100/33FF57/FFFFFF?text=A2',
                'https://via.placeholder.com/100/3357FF/FFFFFF?text=A3',
                'https://via.placeholder.com/100/FF33A1/FFFFFF?text=A4',
                'https://via.placeholder.com/100/33FFF6/FFFFFF?text=A5',
                'https://via.placeholder.com/100/F3FF33/FFFFFF?text=A6',
            ];
            const container = document.getElementById('avatarOptions');
            container.innerHTML = avatars.map(url => `
                <img src="${url}" class="avatar-option ${url === currentAvatar ? 'selected' : ''}" onclick="selectAvatar('${url}')">
            `).join('');
        }

        function selectAvatar(url) {
            document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
            document.querySelector(`.avatar-option[src="${url}"]`).classList.add('selected');
            document.getElementById('profileAvatar').src = url;
        }

        async function updateProfile() {
            const newName = document.getElementById('profileNameEdit').value.trim();
            const newBio = document.getElementById('profileBio').value.trim();
            const newAvatar = document.querySelector('.avatar-option.selected').src;

            if (!newName) {
                return showNotification('الاسم لا يمكن أن يكون فارغاً.', 'error');
            }

            try {
                await db.collection('users').doc(currentUser.id).update({
                    name: newName,
                    bio: newBio,
                    avatar: newAvatar
                });
                
                currentUser.name = newName;
                currentUser.bio = newBio;
                currentUser.avatar = newAvatar;
                
                updateHeaderUI();
                showNotification('تم تحديث الملف الشخصي بنجاح!');
                showUserProfile(currentUser.id); // Re-render profile modal
                
            } catch (error) {
                console.error("Error updating profile:", error);
                showNotification('فشل تحديث الملف الشخصي.', 'error');
            }
        }

        // =================================================================
        // PRIVATE MESSAGES
        // =================================================================

        function showPrivateMessages() {
            document.getElementById('roomsView').classList.add('hidden');
            document.getElementById('chatView').classList.add('hidden');
            document.getElementById('adminView').classList.add('hidden');
            document.getElementById('privateMessagesView').classList.remove('hidden');
            document.getElementById('privateChatView').classList.add('hidden');
            
            if (messagesListener) {
                messagesListener();
                messagesListener = null;
            }
            currentRoom = null;
            renderPrivateChatsList();
        }

        function goBackToPrivateChats() {
            showPrivateMessages();
        }

        async function startPrivateChat(targetUserId, targetUserName, targetUserAvatar) {
            if (!currentUser) return;
            
            const users = [currentUser.id, targetUserId].sort();
            const chatId = users.join('_');
            
            // Create chat document if it doesn't exist
            const chatRef = db.collection('privateChats').doc(chatId);
            const chatDoc = await chatRef.get();
            
            if (!chatDoc.exists) {
                await chatRef.set({
                    users: users,
                    userNames: { [currentUser.id]: currentUser.name, [targetUserId]: targetUserName },
                    userAvatars: { [currentUser.id]: currentUser.avatar, [targetUserId]: targetUserAvatar },
                    lastMessage: '',
                    lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            showPrivateChat(chatId, targetUserName);
            closeModal('profileView');
        }

        function showPrivateChat(chatId, userName) {
            currentPrivateChatId = chatId;
            document.getElementById('privateMessagesView').classList.add('hidden');
            document.getElementById('privateChatView').classList.remove('hidden');
            document.getElementById('privateChatUserName').textContent = userName;
            document.getElementById('privateMessagesContainer').innerHTML = '';
            
            renderPrivateMessages();
        }

        async function sendPrivateMessage() {
            const input = document.getElementById('privateMessageInput');
            const content = input.value.trim();
            
            if (!content || !currentPrivateChatId || !currentUser) return;
            
            input.value = '';
            
            try {
                const messageData = {
                    senderId: currentUser.id,
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const chatRef = db.collection('privateChats').doc(currentPrivateChatId);
                await chatRef.collection('messages').add(messageData);
                
                // Update last message in chat document
                await chatRef.update({
                    lastMessage: content,
                    lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error("Error sending private message: ", error);
                input.value = content;
            }
        }

        function renderPrivateMessages() {
            const container = document.getElementById('privateMessagesContainer');
            if (!currentPrivateChatId) return;
            if (privateMessagesListener) privateMessagesListener();

            privateMessagesListener = db.collection('privateChats').doc(currentPrivateChatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .limitToLast(100)
                .onSnapshot(snapshot => {
                    container.innerHTML = snapshot.docs.map(doc => {
                        const msg = { id: doc.id, ...doc.data() };
                        const isSent = msg.senderId === currentUser.id;
                        
                        let messageClass = isSent ? 'message-sent' : 'message-received';
                        
                        const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : '';
                        
                        return `
                            <div class="message ${messageClass}">
                                <div>${msg.content.replace(/\n/g, '<br>')}</div>
                                <div style="font-size: 12px; opacity: 0.7; margin-top: 4px; text-align: left;">${timestamp}</div>
                            </div>
                        `;
                    }).join('');
                    container.scrollTop = container.scrollHeight;
                }, error => console.error("Error fetching private messages: ", error));
        }

        async function renderPrivateChatsList() {
            const listDiv = document.getElementById('privateChatsList');
            listDiv.innerHTML = 'جاري تحميل المحادثات الخاصة...';
            
            try {
                const snapshot = await db.collection('privateChats')
                    .where('users', 'array-contains', currentUser.id)
                    .orderBy('lastMessageTimestamp', 'desc')
                    .get();
                
                const chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                listDiv.innerHTML = chats.map(chat => {
                    const targetUserId = chat.users.find(id => id !== currentUser.id);
                    const targetUserName = chat.userNames[targetUserId] || 'مستخدم محذوف';
                    const targetUserAvatar = chat.userAvatars[targetUserId] || 'https://via.placeholder.com/100';
                    
                    return `
                        <div class="user-list-item" onclick="showPrivateChat('${chat.id}', '${targetUserName}')" style="cursor: pointer;">
                            <div class="user-info">
                                <img src="${targetUserAvatar}" class="profile-btn" alt="Avatar">
                                <div>
                                    <strong>${targetUserName}</strong>
                                    <p style="font-size: 14px; color: #6b7280;">${chat.lastMessage.substring(0, 30)}...</p>
                                </div>
                            </div>
                            <span style="font-size: 12px; color: #9ca3af;">${chat.lastMessageTimestamp ? new Date(chat.lastMessageTimestamp.toDate()).toLocaleTimeString('ar-SA') : ''}</span>
                        </div>
                    `;
                }).join('');
                
                if (chats.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center; color: #6b7280;">لا توجد محادثات خاصة حالياً.</p>';
                }

            } catch (error) {
                console.error("Error rendering private chats:", error);
                listDiv.innerHTML = '<p style="text-align: center; color: #ef4444;">فشل تحميل المحادثات الخاصة.</p>';
            }
        }

        // =================================================================
        // ADMIN DASHBOARD
        // =================================================================

        async function renderAdminDashboard() {
            if (currentUser.role !== 'admin') return;
            
            try {
                const [usersSnapshot, roomsSnapshot, messagesSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('rooms').get(),
                    db.collection('stats').doc('messages').get() // Assuming a stats document for total messages
                ]);

                const totalUsers = usersSnapshot.size;
                const onlineUsers = usersSnapshot.docs.filter(doc => doc.data().isOnline).length;
                const totalRooms = roomsSnapshot.size;
                const totalMessages = messagesSnapshot.exists ? messagesSnapshot.data().count : 0;

                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('onlineUsers').textContent = onlineUsers;
                document.getElementById('totalRooms').textContent = totalRooms;
                document.getElementById('totalMessages').textContent = totalMessages;

            } catch (error) {
                console.error("Error rendering admin dashboard:", error);
            }
        }

        async function renderUserList() {
            if (currentUser.role !== 'admin') return;
            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = 'جاري تحميل المستخدمين...';
            
            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                userListDiv.innerHTML = users.map(user => `
                    <div class="user-list-item">
                        <div class="user-info">
                            <img src="${user.avatar}" class="profile-btn" alt="Avatar">
                            <div>
                                <strong>${user.name}</strong>
                                <p style="font-size: 14px; color: #6b7280;">${user.email}</p>
                            </div>
                        </div>
                        <div class="user-actions">
                            <span class="user-badge ${getRoleClass(user.role)}">${getRoleText(user.role)}</span>
                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="showAdminActionsModal('${user.id}', ${JSON.stringify(user).replace(/"/g, '&quot;')})">إجراءات</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error("Error rendering user list:", error);
                userListDiv.innerHTML = '<p style="text-align: center; color: #ef4444;">فشل تحميل قائمة المستخدمين.</p>';
            }
        }

        function showAdminActionsModal(userId, userData) {
            currentAdminActionUserId = userId;
            currentAdminActionUserData = userData;
            
            document.getElementById('adminActionUserName').textContent = userData.name;
            
            // Toggle Ban/Unban buttons
            document.getElementById('banUserBtn').classList.toggle('hidden', userData.isBanned);
            document.getElementById('unbanUserBtn').classList.toggle('hidden', !userData.isBanned);

            // Toggle Promote/Demote Mod buttons
            document.getElementById('promoteToModBtn').classList.toggle('hidden', userData.role === 'moderator' || userData.role === 'admin');
            document.getElementById('demoteFromModBtn').classList.toggle('hidden', userData.role !== 'moderator');

            // Toggle Promote/Demote Admin buttons
            document.getElementById('promoteToAdminBtn').classList.toggle('hidden', userData.role === 'admin');
            document.getElementById('demoteFromAdminBtn').classList.toggle('hidden', userData.role !== 'admin');

            document.getElementById('adminActionsModal').classList.add('active');
        }

        async function banUser() {
            if (!confirm(`هل أنت متأكد من حظر المستخدم ${currentAdminActionUserData.name}؟`)) return;
            try {
                await db.collection('users').doc(currentAdminActionUserId).update({
                    isBanned: true
                });
                showNotification(`تم حظر ${currentAdminActionUserData.name} بنجاح.`, 'error');
                closeModal('adminActionsModal');
                renderUserList();
            } catch (error) {
                console.error("Error banning user:", error);
                showNotification('فشل حظر المستخدم.', 'error');
            }
        }

        async function unbanUser() {
            if (!confirm(`هل أنت متأكد من إلغاء حظر المستخدم ${currentAdminActionUserData.name}؟`)) return;
            try {
                await db.collection('users').doc(currentAdminActionUserId).update({
                    isBanned: false
                });
                showNotification(`تم إلغاء حظر ${currentAdminActionUserData.name} بنجاح.`, 'success');
                closeModal('adminActionsModal');
                renderUserList();
            } catch (error) {
                console.error("Error unbanning user:", error);
                showNotification('فشل إلغاء حظر المستخدم.', 'error');
            }
        }

        async function promoteUser(newRole) {
            const roleText = getRoleText(newRole);
            if (!confirm(`هل أنت متأكد من تغيير دور ${currentAdminActionUserData.name} إلى ${roleText}؟`)) return;
            try {
                await db.collection('users').doc(currentAdminActionUserId).update({
                    role: newRole
                });
                showNotification(`تم تغيير دور ${currentAdminActionUserData.name} إلى ${roleText} بنجاح.`, 'success');
                closeModal('adminActionsModal');
                renderUserList();
            } catch (error) {
                console.error("Error promoting user:", error);
                showNotification('فشل تغيير دور المستخدم.', 'error');
            }
        }

        async function renderAdminRoomList() {
            if (currentUser.role !== 'admin') return;
            const roomListDiv = document.getElementById('roomList');
            roomListDiv.innerHTML = 'جاري تحميل الغرف...';
            
            try {
                const snapshot = await db.collection('rooms').orderBy('createdAt', 'asc').get();
                const rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                roomListDiv.innerHTML = rooms.map(room => `
                    <div class="user-list-item">
                        <div class="user-info">
                            <div>
                                <strong>${room.name}</strong>
                                <p style="font-size: 14px; color: #6b7280;">${room.description}</p>
                            </div>
                        </div>
                        <div class="user-actions">
                            <span class="user-badge ${room.isHidden ? 'admin-badge' : 'user-badge-default'}">${room.isHidden ? 'مخفية' : 'عامة'}</span>
                            <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteRoom('${room.id}', '${room.name}')">حذف</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error("Error rendering admin room list:", error);
                roomListDiv.innerHTML = '<p style="text-align: center; color: #ef4444;">فشل تحميل قائمة الغرف.</p>';
            }
        }

        async function deleteRoom(roomId, roomName) {
            if (!confirm(`هل أنت متأكد من حذف الغرفة ${roomName}؟ سيتم حذف جميع الرسائل.`)) return;
            try {
                // Delete all messages subcollection (requires more complex logic or cloud function, simplified here)
                // For simplicity, we assume a cloud function handles subcollection deletion.
                await db.collection('rooms').doc(roomId).delete();
                
                showNotification(`تم حذف الغرفة ${roomName} بنجاح.`, 'success');
                renderAdminRoomList();
                renderRooms();
            } catch (error) {
                console.error("Error deleting room:", error);
                showNotification('فشل حذف الغرفة.', 'error');
            }
        }

        // =================================================================
        // ADS MANAGEMENT
        // =================================================================

        async function listenForAds() {
            const adsBanner = document.getElementById('ads-banner');
            const adsBannerContainer = document.getElementById('ads-banner-container');
            
            db.collection('settings').doc('ads').onSnapshot(doc => {
                if (doc.exists && doc.data().items && doc.data().items.length > 0) {
                    const ads = doc.data().items;
                    adsBanner.innerHTML = ads.map(ad => `<div class="ads-banner-item">${ad}</div>`).join('<div class="ads-separator"></div>');
                    adsBannerContainer.classList.remove('hidden');
                } else {
                    adsBannerContainer.classList.add('hidden');
                }
            }, error => console.error("Error listening for ads:", error));
        }

        async function addAd() {
            const input = document.getElementById('newAdInput');
            const newAd = input.value.trim();
            if (!newAd) return showNotification('الرجاء إدخال نص الإعلان.', 'error');

            try {
                const adsRef = db.collection('settings').doc('ads');
                await adsRef.update({
                    items: firebase.firestore.FieldValue.arrayUnion(newAd)
                });
                input.value = '';
                showNotification('تم إضافة الإعلان بنجاح!');
                renderAdsManagement();
            } catch (error) {
                // If document doesn't exist, create it
                if (error.code === 'not-found') {
                    await db.collection('settings').doc('ads').set({
                        items: [newAd]
                    });
                    input.value = '';
                    showNotification('تم إضافة الإعلان بنجاح!');
                    renderAdsManagement();
                } else {
                    console.error("Error adding ad:", error);
                    showNotification('فشل إضافة الإعلان.', 'error');
                }
            }
        }

        async function deleteAd(ad) {
            if (!confirm(`هل أنت متأكد من حذف الإعلان: "${ad}"؟`)) return;
            try {
                const adsRef = db.collection('settings').doc('ads');
                await adsRef.update({
                    items: firebase.firestore.FieldValue.arrayRemove(ad)
                });
                showNotification('تم حذف الإعلان بنجاح!');
                renderAdsManagement();
            } catch (error) {
                console.error("Error deleting ad:", error);
            }
        }

        async function renderAdsManagement() {
            const adsListDiv = document.getElementById("ads-list");
            adsListDiv.innerHTML = '';
            const doc = await db.collection("settings").doc("ads").get();
            if (doc.exists && doc.data().items) {
                const ads = doc.data().items;
                adsListDiv.innerHTML = ads.map(ad => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #e5e7eb;">
                        <span>${ad}</span>
                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteAd('${ad}')">حذف</button>
                    </div>
                `).join('');
            }
        }

        // =================================================================
        // UTILITY & HELPER FUNCTIONS
        // =================================================================

        function getRoleText(role) {
            const roles = { admin: 'مدير', moderator: 'مشرف', user: 'عضو' };
            return roles[role] || 'عضو';
        }

        function getRoleClass(role) {
            const roleClasses = { admin: 'admin-badge', moderator: 'moderator-badge' };
            return roleClasses[role] || 'user-badge-default';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showAdminNotification() {
            const container = document.getElementById('adminNotificationContainer');
            container.innerHTML = `<div class="admin-notification">🔥 أنت مدير هذا التطبيق! يمكنك إدارة المستخدمين والغرف من لوحة الإدارة.</div>`;
        }

        function initializeEmojiPicker() {
            const emojis = ['😀', '😂', '❤️', '👍', '🔥', '😊', '🥰', '🤔', '🎉', '🙏', '😭', '😎', '😮', '🤯', '😴', '👋'];
            const grid = document.getElementById('emojiGrid');
            if (grid.children.length === 0) { // Only initialize if empty
                grid.innerHTML = emojis.map(emoji => `<button class="emoji-btn" onclick="insertEmoji('${emoji}')">${emoji}</button>`).join('');
            }
        }

        function toggleEmojiPicker() { document.getElementById('emojiPicker').classList.toggle('active'); }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
        }

        function toggleMessageOptions(event, userId, userName) {
            event.stopPropagation();
            document.querySelectorAll('.options-menu').forEach(menu => menu.remove());
            
            const menu = document.createElement('div');
            menu.className = 'options-menu';
            menu.innerHTML = `
                <button onclick="blockUser('${userId}', '${userName}')">🚫 حظر المستخدم</button>
                <button onclick="reportUser('${userId}', '${userName}')">🚩 إبلاغ عن المستخدم</button>
            `;
            event.target.closest('.message-options').appendChild(menu);
            
            setTimeout(() => {
                document.addEventListener('click', () => menu.remove(), { once: true });
            }, 100);
        }
        
        async function blockUser(userId, userName) {
            if (!confirm(`هل أنت متأكد من حظر ${userName}؟ لن تتمكن من رؤية رسائله بعد الآن.`)) return;
            try {
                await db.collection('users').doc(currentUser.id).update({
                    blockedUsers: firebase.firestore.FieldValue.arrayUnion(userId)
                });
                currentUser.blockedUsers = [...(currentUser.blockedUsers || []), userId];
                showNotification(`تم حظر ${userName} بنجاح`);
                renderMessages();
            } catch (error) {
                console.error('Error blocking user:', error);
            }
        }
        
        async function reportUser(userId, userName) {
            const reason = prompt(`لماذا تريد الإبلاغ عن ${userName}؟`, '');
            if (!reason || !reason.trim()) return;
            try {
                await db.collection('reports').add({
                    reportedUserId: userId, reportedUserName: userName,
                    reporterUserId: currentUser.id, reporterUserName: currentUser.name,
                    reason: reason.trim(), roomId: currentRoom ? currentRoom.id : 'N/A', roomName: currentRoom ? currentRoom.name : 'N/A',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(), status: 'pending'
                });
                showNotification(`تم إرسال البلاغ عن ${userName} بنجاح.`);
            } catch (error) {
                console.error('Error reporting user:', error);
            }
        }

        // =================================================================
        // GLOBAL EVENT LISTENERS
        // =================================================================

        document.addEventListener("DOMContentLoaded", () => {
            // No applyHeaderImageOnLoad function found, removing call.
        });

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function listenForNotifications() {
            // Listen for global notifications
            db.collection('settings').doc('globalNotification').onSnapshot(doc => {
                if (doc.exists) {
                    const notification = doc.data();
                    const notificationTime = notification.createdAt.toDate();
                    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                    if (notificationTime > fiveMinutesAgo) {
                        showNotification(`تنبيه عام: ${notification.text}`);
                    }
                }
            });
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>
