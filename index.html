<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Øª Ø§Ù„Ø¹Ø²Ø§ÙˆÙŠ - ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¯Ø´Ø© Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- START: FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <!-- END: FIREBASE SDK -->

    <style>
        /* All your existing CSS styles go here. */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100% ); min-height: 100vh; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        @media (min-width: 768px) { .container { padding: 20px; } }
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 20px; }
        @media (min-width: 768px) { .card { padding: 24px; } }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        @media (min-width: 768px) { .btn { padding: 12px 24px; font-size: 16px; } }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-google { background-color: #4285F4; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-google:hover { background-color: #357ae8; }
        .room-card { background: white; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .room-card:hover { transform: translateY(-5px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .room-card img { width: 100%; height: 150px; object-fit: cover; }
        @media (min-width: 768px) { .room-card img { height: 200px; } }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .message { 
            padding: 12px 16px; 
            border-radius: 12px; 
            margin-bottom: 12px; 
            max-width: 85%; 
            animation: slideIn 0.3s ease-out; 
            word-wrap: break-word; 
            position: relative;
            clear: both;
        }
        @media (min-width: 768px) { .message { max-width: 70%; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-sent { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            margin-left: auto; 
            margin-right: 0;
            float: right;
        }
        .message-received { 
            background: #f3f4f6; 
            color: #1f2937; 
            margin-right: auto; 
            margin-left: 0;
            float: left;
        }
        .message-admin { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); 
            color: white; 
            margin-right: auto; 
            position: relative; 
            animation: fireGlow 2s ease-in-out infinite; 
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5); 
            float: left;
        }
        @keyframes fireGlow { 0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.5); } 50% { box-shadow: 0 0 30px rgba(255, 107, 107, 0.8), 0 0 40px rgba(238, 90, 36, 0.6); } }
        .message-admin::before { content: 'ğŸ”¥'; position: absolute; top: -10px; right: -10px; font-size: 20px; animation: fireFloat 1.5s ease-in-out infinite; }
        @keyframes fireFloat { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-5px) rotate(10deg); } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 10px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        @media (min-width: 768px) { .modal-content { padding: 32px; } }
        .input-field { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; margin-bottom: 16px; transition: border-color 0.3s; }
        .input-field:focus { outline: none; border-color: #667eea; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        @media (min-width: 768px) { .stat-card { padding: 24px; } }
        .tab-button { padding: 10px 16px; border: none; background: transparent; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; transition: all 0.3s; font-size: 14px; }
        @media (min-width: 768px) { .tab-button { padding: 12px 24px; font-size: 16px; } }
        .tab-button.active { border-bottom-color: #667eea; color: #667eea; }
        .hidden { display: none !important; }
        .grid { display: grid; gap: 15px; }
        @media (min-width: 768px) { .grid { gap: 20px; } }
        .grid-cols-2 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        @media (min-width: 768px) { .grid-cols-2 { grid-template-columns: repeat(2, 1fr); } }
        .grid-cols-4 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        @media (min-width: 768px) { .grid-cols-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } }
        .main-header { background: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/%D9%85%D9%84%D8%A7%D8%B0-%D8%A7%D9%84%D8%B0%D9%87%D8%A8%D9%8A3-%D8%A7%D9%84%D9%85%D8%AA%D8%AD%D8%B1%D9%83-1-tkGUJkQJVKQoTmRIFbMFUpI8gCzfkJ.gif' ) center/cover; padding: 16px 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); position: relative; }
        .main-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.85); border-radius: 16px; z-index: 0; }
        .main-header > * { position: relative; z-index: 1; }
        @media (min-width: 768px) { .main-header { padding: 20px 32px; } }
        .header-title { font-size: 28px; font-weight: 900; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: titlePulse 3s ease-in-out infinite; text-align: center; margin-bottom: 16px; }
        @media (min-width: 768px) { .header-title { font-size: 36px; margin-bottom: 0; text-align: right; } }
        @keyframes titlePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .nav-links { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-bottom: 16px; }
        @media (min-width: 768px) { .nav-links { gap: 20px; margin-bottom: 0; justify-content: flex-start; } }
        .nav-link { padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s; animation: navFloat 3s ease-in-out infinite; text-decoration: none; display: inline-block; }
        @media (min-width: 768px) { .nav-link { padding: 10px 20px; font-size: 14px; } }
        .nav-link:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .nav-link:nth-child(1) { animation-delay: 0s; }
        .nav-link:nth-child(2) { animation-delay: 0.2s; }
        .nav-link:nth-child(3) { animation-delay: 0.4s; }
        .nav-link:nth-child(4) { animation-delay: 0.6s; }
        @keyframes navFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-3px); } }
        .header { background: white; padding: 12px 16px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex-wrap: wrap; gap: 10px; }
        @media (min-width: 768px) { .header { padding: 16px 24px; margin-bottom: 24px; flex-wrap: nowrap; } }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            background: white; 
            border-radius: 0; 
            overflow: hidden; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            z-index: 100; 
        }
        @media (min-width: 768px) { 
            .chat-container { 
                height: calc(100vh - 100px); 
                position: relative;
                border-radius: 16px;
            } 
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .messages-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: block;
            padding-bottom: 120px; /* Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
            min-height: 0; /* Ù…Ù‡Ù… Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù€ flex ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
        }
        @media (min-width: 768px) { 
            .messages-container { 
                padding: 20px; 
                padding-bottom: 140px; 
            } 
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø­Ø§ÙˆÙŠØ© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .message-input-container { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            padding: 15px; 
            border-top: 2px solid #e5e7eb; 
            display: flex; 
            gap: 8px; 
            background: white; 
            z-index: 101; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
        }
        @media (min-width: 768px) { 
            .message-input-container { 
                padding: 20px; 
                gap: 12px; 
                position: absolute;
                bottom: 0;
            } 
        }
        
        .user-badge { display: inline-block; padding: 4px 12px; background: #10b981; color: white; border-radius: 12px; font-size: 12px; font-weight: 600; animation: badgePulse 2s ease-in-out infinite; }
        @keyframes badgePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .admin-badge { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); animation: adminBadgeGlow 2s ease-in-out infinite; }
        @keyframes adminBadgeGlow { 0%, 100% { box-shadow: 0 0 10px rgba(255, 107, 107, 0.5); } 50% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.8); } }
        .moderator-badge { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); animation: moderatorBadgeGlow 2s ease-in-out infinite; }
        @keyframes moderatorBadgeGlow { 0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); } 50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); } }
        .banned-badge { background: #6b7280; animation: none; }
        table { width: 100%; border-collapse: collapse; overflow-x: auto; display: block; }
        @media (min-width: 768px) { table { display: table; } }
        th, td { padding: 8px; text-align: right; border-bottom: 1px solid #e5e7eb; font-size: 12px; }
        @media (min-width: 768px) { th, td { padding: 12px; font-size: 14px; } }
        th { background: #f9fafb; font-weight: 600; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        @media (min-width: 768px) { .avatar { width: 40px; height: 40px; } }
        .title-main { font-size: 20px; font-weight: bold; }
        @media (min-width: 768px) { .title-main { font-size: 24px; } }
        .title-section { font-size: 24px; font-weight: bold; }
        @media (min-width: 768px) { .title-section { font-size: 32px; } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Enhanced Notification Bar */
        .notification-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
            font-weight: 700;
            font-size: 16px;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);
            transform: translateY(-100%);
            transition: transform 0.5s ease-out;
            overflow: hidden;
        }
        
        .notification-bar.active {
            transform: translateY(0);
            animation: notificationGlow 2s ease-in-out infinite;
        }
        
        .notification-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: slideRight 3s linear infinite;
        }
        
        @keyframes slideRight {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes notificationGlow { 
            0%, 100% { box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4); } 
            50% { box-shadow: 0 4px 30px rgba(255, 107, 107, 0.7); } 
        }
        
        .notification-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .notification-icon {
            font-size: 20px;
            animation: bounce 1s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .admin-notification { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 12px 20px; border-radius: 12px; margin-bottom: 12px; text-align: center; font-weight: bold; animation: slideDown 0.5s ease-out, notificationGlow 2s ease-in-out infinite; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .emoji-picker { position: absolute; bottom: 70px; right: 20px; background: white; border-radius: 16px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); display: none; max-width: 320px; z-index: 1000; }
        .emoji-picker.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 200px; overflow-y: auto; }
        .emoji-btn { font-size: 28px; padding: 8px; border: none; background: transparent; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .emoji-btn:hover { background: #f3f4f6; transform: scale(1.2); }
        .emoji-btn:active { transform: scale(0.95); }
        .profile-btn { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #667eea; cursor: pointer; transition: all 0.3s; object-fit: cover; }
        .profile-btn:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .action-btn { padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; margin: 2px; }
        .action-btn:hover { transform: translateY(-2px); }
        .btn-promote { background: #3b82f6; color: white; }
        .btn-demote { background: #f59e0b; color: white; }
        .btn-ban { background: #ef4444; color: white; }
        .btn-unban { background: #10b981; color: white; }
        .avatar-option { width: 60px; height: 60px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.3s; }
        .avatar-option:hover { border-color: #667eea; transform: scale(1.1); }
        .avatar-option.selected { border-color: #667eea; box-shadow: 0 0 12px rgba(102, 126, 234, 0.5); }
        .divider { text-align: center; margin: 16px 0; color: #9ca3af; }
        
        /* Golden Coins and Messages Styles */
        .golden-coin { 
            display: inline-block; 
            font-size: 16px; 
            animation: coinSpin 2s linear infinite, coinGlow 1.5s ease-in-out infinite alternate; 
            margin-left: 5px; 
        }
        @keyframes coinSpin { 
            0% { transform: rotateY(0deg); } 
            100% { transform: rotateY(360deg); } 
        }
        @keyframes coinGlow { 
            0% { text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700; } 
            100% { text-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700, 0 0 30px #ffd700; } 
        }
        
        .message-golden { 
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%); 
            color: #8b4513; 
            border: 2px solid #ffa500; 
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(255, 255, 255, 0.2); 
            animation: goldenPulse 2s ease-in-out infinite, goldenShimmer 3s linear infinite; 
            position: relative; 
            overflow: hidden; 
        }
        
        .message-golden::before { 
            content: ''; 
            position: absolute; 
            top: -50%; 
            left: -50%; 
            width: 200%; 
            height: 200%; 
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent); 
            animation: goldenShine 2s linear infinite; 
            pointer-events: none; 
        }
        
        @keyframes goldenPulse { 
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); } 
            50% { transform: scale(1.02); box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); } 
        }
        
        @keyframes goldenShimmer { 
            0% { background-position: -200% 0; } 
            100% { background-position: 200% 0; } 
        }
        
        @keyframes goldenShine { 
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); } 
        }
        
        .coins-display { 
            display: inline-flex; 
            align-items: center; 
            background: linear-gradient(135deg, #ffd700, #ffed4e); 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: bold; 
            color: #8b4513; 
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4); 
            animation: coinsBadgeGlow 2s ease-in-out infinite; 
        }
        
        @keyframes coinsBadgeGlow { 
            0%, 100% { box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4); } 
            50% { box-shadow: 0 2px 15px rgba(255, 215, 0, 0.7); } 
        }
        
        /* Message Options */
        .message-options {
            position: absolute;
            top: 5px;
            left: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .message:hover .message-options {
            opacity: 1;
        }
        
        .options-btn {
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .options-menu {
            position: absolute;
            top: 30px;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1000;
            min-width: 150px;
        }
        
        .options-menu button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: transparent;
            text-align: right;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .options-menu button:hover {
            background: #f3f4f6;
        }
        
        /* Likes and Quotes */
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        
        .like-btn, .quote-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            color: inherit;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }
           /* Enhanced Profile Modal Styles */
        .profile-modal {
            max-width: 650px;
            max-height: 95vh;
            overflow-y: auto;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px 20px 0 0;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .profile-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid white;
            margin-bottom: 20px;
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        
        .profile-role-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            position: relative;
            z-index: 1;
        }
        
        .role-admin {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
            animation: adminGlow 2s ease-in-out infinite;
        }
        
        .role-moderator {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            animation: moderatorGlow 2s ease-in-out infinite;
        }
        
        .role-user {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }
        
        @keyframes adminGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 107, 107, 0.8); }
        }
        
        @keyframes moderatorGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.8); }
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 16px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-item:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }
        
        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .stat-item:hover::before {
            left: 100%;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 900;
            color: #667eea;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }
        
        .profile-field {
            margin-bottom: 20px;
        }
        
        .profile-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .profile-field .input-field {
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            font-size: 16px;
            padding: 14px 18px;
        }
        
        .profile-field .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            position: relative;
        }
        
        .status-online {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background: #6b7280;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .country-flag {
            font-size: 20px;
            margin-left: 8px;
        }        
        /* Private Messages */
        .private-message-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b4513;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 16px;
        }
        
        .private-message-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }
        
        .private-message-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Hidden Room Indicator */
        .hidden-room {
            position: relative;
        }
        
        .hidden-room::before {
            content: 'ğŸ”’';
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            z-index: 1;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            z-index: 2000;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.coins {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b4513;
        }
        
        /* File Upload Styles */
        .file-upload {
            position: relative;
            display: inline-block;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-btn {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .file-upload-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        /* Clear floats */
        .messages-container::after {
            content: "";
            display: table;
            clear: both;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 24px; font-size: 28px; font-weight: bold; color: #667eea;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø´Ø§Øª Ø§Ù„Ø¹Ø²Ø§ÙˆÙŠ</h2>
            <div style="text-align: center; margin-bottom: 24px;">
                <button onclick="loginWithGoogle()" class="btn btn-google" style="width: 100%; margin-bottom: 16px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
                </button>
            </div>
            <div class="divider">Ø£Ùˆ</div>
            <input type="email" id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="input-field">
            <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="input-field">
            <div style="display: flex; gap: 12px;">
                <button onclick="loginWithEmail()" class="btn btn-primary" style="flex: 1;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button onclick="registerWithEmail()" class="btn btn-success" style="flex: 1;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            </div>
        </div>
    </div>

    <!-- Global Notification Bar -->
    <div id="globalNotificationBar" class="notification-bar">
        <div class="notification-content">
            <span class="notification-icon">ğŸ“¢</span>
            <span id="notificationText">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø´Ø§Øª Ø§Ù„Ø¹Ø²Ø§ÙˆÙŠ</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Main Header -->
        <div class="main-header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div class="nav-links">
                    <a href="#" class="nav-link" onclick="showRooms()">ğŸ  Ø§Ù„ØºØ±Ù</a>
                    <a href="#" class="nav-link" id="adminBtn" onclick="showAdmin()" class="hidden">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
                </div>
                <h1 class="header-title">Ø´Ø§Øª Ø§Ù„Ø¹Ø²Ø§ÙˆÙŠ</h1>
            </div>
        </div>

        <!-- User Options Bar -->
        <div id="userOptionsBar" class="header hidden" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid #e5e7eb;">
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <img id="userAvatarBtn" class="profile-btn hidden" onclick="showProfile()">
                <span id="userNameDisplay" style="font-weight: 700; color: #374151;"></span>
                <div id="userCoinsDisplay" class="coins-display hidden">
                    <span class="golden-coin">ğŸª™</span>
                    <span id="userCoinsCount" style="font-weight: 700; color: #fbbf24;">0</span>
                </div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="showProfile()" class="btn" style="background: #667eea; color: white; padding: 8px 16px; font-size: 14px;">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
                <button onclick="showPrivateMessages()" class="btn" style="background: #10b981; color: white; padding: 8px 16px; font-size: 14px;">ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©</button>
                <button id="logoutBtn" onclick="logout()" class="btn btn-danger hidden" style="padding: 8px 16px; font-size: 14px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Rooms View -->
        <div id="roomsView" class="hidden">
            <div class="card">
                <h2 class="title-section" style="margin-bottom: 24px; text-align: center;">Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                <div id="roomsGrid" class="grid grid-cols-2"></div>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chatView" class="chat-container hidden">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="goBack()" class="btn btn-primary">â† Ø±Ø¬ÙˆØ¹</button>
                    <div>
                        <h3 id="chatRoomName" class="title-main"></h3>
                        <p id="chatRoomDesc" style="color: #6b7280; font-size: 14px;"></p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <img id="userAvatarBtn2" class="profile-btn hidden" onclick="showProfile()">
                    <span id="userNameDisplay2" style="font-weight: 600;"></span>
                    <div id="userCoinsDisplay2" class="coins-display hidden">
                        <span class="golden-coin">ğŸª™</span>
                        <span id="userCoinsCount2">0</span>
                    </div>
                </div>
            </div>
            
            <div id="adminNotificationContainer"></div>
            
            <div class="messages-container" id="messagesContainer"></div>
            
            <div class="message-input-container">
                <button onclick="toggleEmojiPicker()" class="btn btn-primary" style="background: #fbbf24; border: none; padding: 12px; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">ğŸ˜Š</button>
                <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." style="flex: 1; padding: 14px 20px; border: 2px solid #e5e7eb; border-radius: 25px; font-size: 16px; margin: 0 12px;">
                <button onclick="sendMessage()" class="btn btn-primary" style="background: #667eea; border: none; padding: 12px 20px; border-radius: 25px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                    <span>ğŸ“¤</span>
                    <span>Ø¥Ø±Ø³Ø§Ù„</span>
                </button>
                <button onclick="contactAdmin()" class="btn" style="background: #ef4444; color: white; border: none; padding: 12px; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; margin-left: 8px;" title="Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
                    ğŸ“
                </button>
            </div>
            
            <div id="emojiPicker" class="emoji-picker">
                <div class="emoji-grid" id="emojiGrid"></div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="adminView" class="hidden">
            <div class="card">
                <h2 class="title-section" style="margin-bottom: 24px; text-align: center;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
                
                <!-- Admin Stats -->
                <div class="grid grid-cols-4" style="margin-bottom: 32px;">
                    <div class="stat-card">
                        <h3 style="font-size: 32px; font-weight: bold; margin-bottom: 8px;" id="totalUsers">0</h3>
                        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                    </div>
                    <div class="stat-card">
                        <h3 style="font-size: 32px; font-weight: bold; margin-bottom: 8px;" id="onlineUsers">0</h3>
                        <p>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†</p>
                    </div>
                    <div class="stat-card">
                        <h3 style="font-size: 32px; font-weight: bold; margin-bottom: 8px;" id="totalRooms">0</h3>
                        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºØ±Ù</p>
                    </div>
                    <div class="stat-card">
                        <h3 style="font-size: 32px; font-weight: bold; margin-bottom: 8px;" id="totalMessages">0</h3>
                        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
                    </div>
                </div>

                <!-- Admin Tabs -->
                <div style="border-bottom: 2px solid #e5e7eb; margin-bottom: 24px;">
                    <button class="tab-button active" onclick="switchAdminTab(event, 'users')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
                    <button class="tab-button" onclick="switchAdminTab(event, 'rooms')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù</button>
                    <button class="tab-button" onclick="switchAdminTab(event, 'messages')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
                    <button class="tab-button" onclick="switchAdminTab(event, 'notifications')">Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡</button>
                    <button class="tab-button" onclick="switchAdminTab(event, 'coins')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</button>
                </div>

                <!-- Users Tab -->
                <div id="usersTab" class="admin-tab">
                    <div style="overflow-x: auto;">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                    <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                    <th>Ø§Ù„Ø¯ÙˆØ±</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Rooms Tab -->
                <div id="roomsTab" class="admin-tab hidden">
                    <button onclick="showAddRoomModal()" class="btn btn-success" style="margin-bottom: 16px;">Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    <div style="overflow-x: auto;">
                        <table id="roomsTable">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©</th>
                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</th>
                                    <th>Ù…Ø®ÙÙŠØ©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="roomsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div id="messagesTab" class="admin-tab hidden">
                    <div style="margin-bottom: 16px;">
                        <select id="roomSelect" class="input-field" onchange="loadRoomMessages()">
                            <option value="">Ø§Ø®ØªØ± ØºØ±ÙØ©</option>
                        </select>
                    </div>
                    <div id="roomMessagesContainer">
                        <p style="text-align: center; color: #6b7280;">Ø§Ø®ØªØ± ØºØ±ÙØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div id="notificationsTab" class="admin-tab hidden">
                    <div style="max-width: 500px; margin: 0 auto;">
                        <h3 style="margin-bottom: 16px;">Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                        <textarea id="notificationText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§..." class="input-field" rows="4"></textarea>
                        <button onclick="sendGlobalNotification()" class="btn btn-primary" style="width: 100%;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
                    </div>
                </div>

                <!-- Coins Tab -->
                <div id="coinsTab" class="admin-tab hidden">
                    <div style="max-width: 500px; margin: 0 auto;">
                        <h3 style="margin-bottom: 16px;">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆÙŠÙ†Ø² Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                        <select id="userSelect" class="input-field">
                            <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…</option>
                        </select>
                        <input type="number" id="coinsAmount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²" class="input-field" min="1">
                        <button onclick="sendCoins()" class="btn btn-primary" style="width: 100%;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content profile-modal">
            <div class="profile-header">
                <img id="profileAvatar" class="profile-avatar" src="">
                <h3 id="profileName" class="profile-name"></h3>
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                    <span id="profileCountryFlag" class="country-flag">ğŸŒ</span>
                    <span id="profileStatus" style="font-size: 16px; font-weight: 600;">Ù…ØªÙˆØ§Ø¬Ø¯</span>
                    <span id="profileStatusIndicator" class="status-indicator status-online"></span>
                </div>
                <div id="profileRole" class="profile-role-badge role-user">Ø¹Ø¶Ùˆ</div>
            </div>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="profileCoins">0</div>
                    <div class="stat-label">Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profileMessages">0</div>
                    <div class="stat-label">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profileJoinDate">-</div>
                    <div class="stat-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profileBirthDate">-</div>
                    <div class="stat-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</div>
                </div>
            </div>
            
            <div class="profile-field">
                <label>Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©:</label>
                <textarea id="profileBio" class="input-field" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹ Ø¹Ù† Ù†ÙØ³Ùƒ..."></textarea>
            </div>
            
            <div class="profile-field">
                <label>Ø§Ù„Ø§Ø³Ù…:</label>
                <input type="text" id="profileNameEdit" class="input-field" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
            </div>
            
            <div class="profile-field">
                <label>Ø§Ù„Ø¨Ù„Ø¯:</label>
                <select id="profileCountry" class="input-field">
                    <option value="ğŸ‡¸ğŸ‡¦">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</option>
                    <option value="ğŸ‡¦ğŸ‡ª">ğŸ‡¦ğŸ‡ª Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</option>
                    <option value="ğŸ‡°ğŸ‡¼">ğŸ‡°ğŸ‡¼ Ø§Ù„ÙƒÙˆÙŠØª</option>
                    <option value="ğŸ‡¶ğŸ‡¦">ğŸ‡¶ğŸ‡¦ Ù‚Ø·Ø±</option>
                    <option value="ğŸ‡§ğŸ‡­">ğŸ‡§ğŸ‡­ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†</option>
                    <option value="ğŸ‡´ğŸ‡²">ğŸ‡´ğŸ‡² Ø¹Ù…Ø§Ù†</option>
                    <option value="ğŸ‡¯ğŸ‡´">ğŸ‡¯ğŸ‡´ Ø§Ù„Ø£Ø±Ø¯Ù†</option>
                    <option value="ğŸ‡±ğŸ‡§">ğŸ‡±ğŸ‡§ Ù„Ø¨Ù†Ø§Ù†</option>
                    <option value="ğŸ‡¸ğŸ‡¾">ğŸ‡¸ğŸ‡¾ Ø³ÙˆØ±ÙŠØ§</option>
                    <option value="ğŸ‡®ğŸ‡¶">ğŸ‡®ğŸ‡¶ Ø§Ù„Ø¹Ø±Ø§Ù‚</option>
                    <option value="ğŸ‡ªğŸ‡¬">ğŸ‡ªğŸ‡¬ Ù…ØµØ±</option>
                    <option value="ğŸ‡±ğŸ‡¾">ğŸ‡±ğŸ‡¾ Ù„ÙŠØ¨ÙŠØ§</option>
                    <option value="ğŸ‡¹ğŸ‡³">ğŸ‡¹ğŸ‡³ ØªÙˆÙ†Ø³</option>
                    <option value="ğŸ‡©ğŸ‡¿">ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</option>
                    <option value="ğŸ‡²ğŸ‡¦">ğŸ‡²ğŸ‡¦ Ø§Ù„Ù…ØºØ±Ø¨</option>
                    <option value="ğŸ‡¸ğŸ‡©">ğŸ‡¸ğŸ‡© Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</option>
                    <option value="ğŸ‡¾ğŸ‡ª">ğŸ‡¾ğŸ‡ª Ø§Ù„ÙŠÙ…Ù†</option>
                    <option value="ğŸ‡µğŸ‡¸">ğŸ‡µğŸ‡¸ ÙÙ„Ø³Ø·ÙŠÙ†</option>
                    <option value="ğŸŒ">ğŸŒ Ø£Ø®Ø±Ù‰</option>
                </select>
            </div>
            
            <div class="profile-field">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</label>
                <input type="date" id="profileBirthDateEdit" class="input-field">
            </div>
            
            <div class="profile-field">
                <label>Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©:</label>
                <div class="file-upload" style="width: 100%; margin-bottom: 16px;">
                    <input type="file" id="profileImageUpload" accept="image/*" onchange="handleProfileImageUpload(event)">
                    <div class="file-upload-btn" style="width: 100%; text-align: center; padding: 12px; border-radius: 12px;">ğŸ“· Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
                </div>
                <div>
                    <p style="margin-bottom: 12px; font-weight: 600; color: #6b7280;">Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ§Ø­Ø©:</p>
                    <div id="avatarOptions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 12px;"></div>
                </div>
            </div>
            
            <button id="privateMessageBtn" class="private-message-btn" onclick="openPrivateMessage()" style="width: 100%; display: none; margin-top: 20px;">
                ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© (ÙŠØªØ·Ù„Ø¨ ÙƒÙˆÙŠÙ†Ø²)
            </button>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="updateProfile()" class="btn btn-primary" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 700;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                <button onclick="closeProfileModal()" class="btn" style="flex: 1; background: #6b7280; color: white; padding: 14px; font-size: 16px;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Add Room Modal -->
    <div id="addRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <input type="text" id="newRoomName" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©" class="input-field">
            <textarea id="newRoomDesc" placeholder="ÙˆØµÙ Ø§Ù„ØºØ±ÙØ©" class="input-field" rows="3"></textarea>
            <input type="url" id="newRoomImage" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºØ±ÙØ©" class="input-field">
            <div style="margin-bottom: 16px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="newRoomHidden">
                    <span>ØºØ±ÙØ© Ù…Ø®ÙÙŠØ© (Ù„Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† ÙÙ‚Ø·)</span>
                </label>
            </div>
            <div style="display: flex; gap: 12px;">
                <button onclick="addRoom()" class="btn btn-success" style="flex: 1;">Ø¥Ø¶Ø§ÙØ©</button>
                <button onclick="closeAddRoomModal()" class="btn" style="flex: 1; background: #6b7280; color: white;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Edit Room Modal -->
    <div id="editRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØºØ±ÙØ©</h2>
            <input type="hidden" id="editRoomId">
            <input type="text" id="editRoomName" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©" class="input-field">
            <textarea id="editRoomDesc" placeholder="ÙˆØµÙ Ø§Ù„ØºØ±ÙØ©" class="input-field" rows="3"></textarea>
            <input type="url" id="editRoomImage" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºØ±ÙØ©" class="input-field">
            <div style="margin-bottom: 16px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="editRoomHidden">
                    <span>ØºØ±ÙØ© Ù…Ø®ÙÙŠØ© (Ù„Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† ÙÙ‚Ø·)</span>
                </label>
            </div>
            <div style="display: flex; gap: 12px;">
                <button onclick="updateRoom()" class="btn btn-success" style="flex: 1;">Ø­ÙØ¸</button>
                <button onclick="closeEditRoomModal()" class="btn" style="flex: 1; background: #6b7280; color: white;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Private Messages Modal -->
    <div id="privateMessagesModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©</h2>
            <div id="privateMessagesContainer">
                <p style="text-align: center; color: #6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø§ØµØ©</p>
            </div>
            <button onclick="closePrivateMessagesModal()" class="btn" style="background: #6b7280; color: white; width: 100%;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // =================================================================
        // FIREBASE CONFIGURATION
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAyn2M8LGYpCFFMY1jsVzc80f0H9mVvh6Q",
            authDomain: "chate-2d1d1.firebaseapp.com",
            projectId: "chate-2d1d1",
            storageBucket: "chate-2d1d1.firebasestorage.app",
            messagingSenderId: "34207834349",
            appId: "1:34207834349:web:3c4c5971f3131ca1536ce4",
            measurementId: "G-SKTRYF395G"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // =================================================================
        // GLOBAL VARIABLES
        // =================================================================
        let currentUser = null;
        let currentRoom = null;
        let messagesListener = null;
        let usersListener = null;
        let selectedAvatar = null;
        let currentProfileUserId = null;

        // =================================================================
        // AUTHENTICATION
        // =================================================================

        // Monitor authentication state changes
        auth.onAuthStateChanged(user => {
            console.log('Auth state changed:', user);
            if (user) {
                // User is signed in
                handleAuthSuccess(user);
            } else {
                // User is signed out
                currentUser = null;
                showLogin();
            }
        });

        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                // handleAuthSuccess will be called automatically by onAuthStateChanged
            } catch (error) {
                console.error("Error during Google login: ", error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
            }
        }

        async function loginWithEmail() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // handleAuthSuccess will be called automatically by onAuthStateChanged
            } catch (error) {
                console.error("Error during email login: ", error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
            }
        }

        async function registerWithEmail() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }
            
            if (password.length < 6) {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                // handleAuthSuccess will be called automatically by onAuthStateChanged
            } catch (error) {
                console.error("Error during email registration: ", error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ' + error.message);
            }
        }

        async function handleAuthSuccess(user) {
            try {
                console.log('Handling auth success for user:', user.uid);
                
                // Get or create user document
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    // Update existing user
                    currentUser = { id: user.uid, ...userDoc.data() };
                    await db.collection('users').doc(user.uid).update({
                        status: 'online',
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Create new user
                    const userData = {
                        id: user.uid,
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        avatar: user.photoURL || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face',
                        role: 'user',
                        status: 'online',
                        banned: false,
                        coins: 0,
                        goldenUntil: null,
                        bio: '',
                        blockedUsers: [],
                        messageCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('users').doc(user.uid).set(userData);
                    currentUser = userData;
                }
                
                console.log('Current user set:', currentUser);
                updateHeader();
                showRooms();
                
            } catch (error) {
                console.error("Error handling auth success: ", error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
            }
        }

        async function logout() {
            try {
                if (currentUser) {
                    await db.collection('users').doc(currentUser.id).update({
                        status: 'offline',
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                await auth.signOut();
                // showLogin will be called automatically by onAuthStateChanged
            } catch (error) {
                console.error("Error during logout: ", error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' + error.message);
            }
        }

        // =================================================================
        // UI MANAGEMENT
        // =================================================================

        function hideAllViews() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('roomsView').classList.add('hidden');
            document.getElementById('chatView').classList.add('hidden');
            document.getElementById('adminView').classList.add('hidden');
            document.getElementById('secondaryHeader').classList.add('hidden');
        }

        function showLogin() {
            hideAllViews();
            document.getElementById('loginModal').classList.add('active');
            // Clear input fields
            document.getElementById('emailInput').value = '';
            document.getElementById('passwordInput').value = '';
        }

        function updateHeader() {
            if (currentUser) {
                // Show user options bar
                document.getElementById('userOptionsBar').classList.remove('hidden');
                
                // Update avatar
                const userAvatarBtn = document.getElementById('userAvatarBtn');
                if (userAvatarBtn) {
                    userAvatarBtn.src = currentUser.avatar;
                    userAvatarBtn.classList.remove('hidden');
                }
                
                // Update name
                const userNameDisplay = document.getElementById('userNameDisplay');
                if (userNameDisplay) {
                    userNameDisplay.textContent = currentUser.name;
                }
                
                // Show coins if user has any
                const userCoinsDisplay = document.getElementById('userCoinsDisplay');
                const userCoinsCount = document.getElementById('userCoinsCount');
                if (currentUser.coins > 0) {
                    if (userCoinsDisplay) userCoinsDisplay.classList.remove('hidden');
                    if (userCoinsCount) userCoinsCount.textContent = currentUser.coins;
                } else {
                    if (userCoinsDisplay) userCoinsDisplay.classList.add('hidden');
                }
                
                // Show logout button
                document.getElementById('logoutBtn').classList.remove('hidden');
                
                // Show admin button only for admins
                const adminBtn = document.getElementById('adminBtn');
                if (currentUser.role === 'admin' || currentUser.role === 'moderator') {
                    adminBtn.classList.remove('hidden');
                } else {
                    adminBtn.classList.add('hidden');
                }
            } else {
                // Hide user options bar
                document.getElementById('userOptionsBar').classList.add('hidden');
                document.getElementById('userAvatarBtn').classList.add('hidden');
                document.getElementById('userNameDisplay').textContent = '';
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('adminBtn').classList.add('hidden');
            }
        }

        function showRooms() {
            hideAllViews();
            document.getElementById('roomsView').classList.remove('hidden');
            renderRooms();
        }

        function renderRooms() {
            db.collection('rooms').onSnapshot(snapshot => {
                const roomsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Filter hidden rooms for non-admin users
                const filteredRooms = roomsData.filter(room => {
                    if (room.hidden && currentUser.role !== 'admin') {
                        return false;
                    }
                    return true;
                });
                
                const grid = document.getElementById('roomsGrid');
                grid.innerHTML = filteredRooms.map(room => `
                    <div class="room-card ${room.hidden ? 'hidden-room' : ''}" onclick="joinRoom('${room.id}')">
                        <img src="${room.image}" alt="${room.name}">
                        <div style="padding: 20px;">
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${room.name}</h3>
                            <p style="color: #6b7280; font-size: 14px; margin-bottom: 12px;">${room.description}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #667eea; font-weight: 600; font-size: 14px;">ğŸ’¬ ${room.messageCount || 0} Ø±Ø³Ø§Ù„Ø©</span>
                                <span style="color: #10b981; font-weight: 600; font-size: 14px;">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            });
        }

        function joinRoom(roomId) {
            hideAllViews();
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('secondaryHeader').classList.remove('hidden');
            initializeEmojiPicker();
            
            db.collection('rooms').doc(roomId).get().then(doc => {
                if (doc.exists) {
                    currentRoom = { id: doc.id, ...doc.data() };
                    document.getElementById('chatRoomName').textContent = currentRoom.name;
                    document.getElementById('chatRoomDesc').textContent = currentRoom.description;
                    if (currentUser.role === 'admin') showAdminNotification();
                    renderMessages();
                    updateHeader(); // Update header for chat view
                } else {
                    alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
                    showRooms();
                }
            });
        }

        function showAdmin() {
            hideAllViews();
            document.getElementById('adminView').classList.remove('hidden');
            document.getElementById('secondaryHeader').classList.remove('hidden');
            updateAdminStats();
            renderAdminUsers();
            renderAdminRooms();
            loadRoomSelectOptions();
            loadUserSelectOptions();
        }

        function goBack() {
            if (messagesListener) messagesListener();
            if (usersListener) usersListener();
            showRooms();
        }

        // =================================================================
        // CHAT & MESSAGES
        // =================================================================

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content || !currentRoom || !currentUser) return;
            if (currentUser.banned) {
                alert('Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
                return;
            }
            input.value = '';
            try {
                // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø°Ù‡Ø¨ÙŠØ©
                const isGolden = currentUser.goldenUntil && new Date(currentUser.goldenUntil.toDate()) > new Date();
                
                const messageData = {
                    content: content,
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userAvatar: currentUser.avatar,
                    role: currentUser.role || 'user',
                    isGolden: isGolden,
                    userCoins: currentUser.coins || 0,
                    likes: [],
                    likesCount: 0,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('rooms').doc(currentRoom.id).collection('messages').add(messageData);
                
                // Update room message count
                const roomRef = db.collection('rooms').doc(currentRoom.id);
                await roomRef.update({
                    messageCount: firebase.firestore.FieldValue.increment(1)
                });
                
                // Update user message count
                await db.collection('users').doc(currentUser.id).update({
                    messageCount: firebase.firestore.FieldValue.increment(1)
                });
                
                currentUser.messageCount = (currentUser.messageCount || 0) + 1;
                
            } catch (error) {
                console.error("Error sending message: ", error);
                input.value = content;
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            if (!currentRoom) return;
            if (messagesListener) messagesListener();
            messagesListener = db.collection('rooms').doc(currentRoom.id).collection('messages')
                .orderBy('timestamp', 'asc')
                .limitToLast(100)
                .onSnapshot(snapshot => {
                    container.innerHTML = snapshot.docs.map(doc => {
                        const msg = { id: doc.id, ...doc.data() };
                        const isSent = msg.userId === currentUser.id;
                        
                        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø°Ù‡Ø¨ÙŠØ©
                        const isGolden = msg.isGolden || false;
                        let messageClass = msg.role === 'admin' ? 'message-admin' : (isSent ? 'message-sent' : 'message-received');
                        if (isGolden) {
                            messageClass += ' message-golden';
                        }
                        
                        const roleIcon = msg.role === 'admin' ? 'ğŸ‘‘' : msg.role === 'moderator' ? 'â­' : '';
                        const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ar-SA') : '...';
                        
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                        const displayName = isSent ? currentUser.name : msg.userName;
                        const displayAvatar = isSent ? currentUser.avatar : msg.userAvatar;
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…Ù„Ùƒ ÙƒÙˆÙŠÙ†Ø² Ù†Ø´Ø·Ø©
                        const coinsIcon = (isSent && currentUser.goldenUntil && new Date(currentUser.goldenUntil.toDate()) > new Date()) || 
                                         (!isSent && msg.userCoins > 0) ? '<span class="golden-coin">ğŸª™</span>' : '';
                        
                        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø±
                        const isBlocked = currentUser.blockedUsers && currentUser.blockedUsers.includes(msg.userId);
                        if (isBlocked && !isSent) {
                            return ''; // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
                        }
                        
                        // Check if user liked this message
                        const userLiked = msg.likes && msg.likes.includes(currentUser.id);
                        
                        return `
                            <div class="message ${messageClass}" style="position: relative;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <img src="${displayAvatar}" class="avatar" style="width: 24px; height: 24px;" onclick="showUserProfile('${msg.userId}')">
                                    <strong style="font-size: 14px; cursor: pointer;" onclick="showUserProfile('${msg.userId}')">${displayName}</strong>
                                    ${coinsIcon}
                                    ${roleIcon ? `<span style="font-size: 12px;">${roleIcon}</span>` : ''}
                                </div>
                                <div>${msg.content}</div>
                                <div class="message-actions">
                                    <button class="like-btn ${userLiked ? 'liked' : ''}" onclick="toggleLike('${msg.id}')">
                                        â¤ï¸ ${msg.likesCount || 0}
                                    </button>
                                    <button class="quote-btn" onclick="quoteMessage('${msg.content}', '${displayName}')">
                                        ğŸ’¬ Ø§Ù‚ØªØ¨Ø§Ø³
                                    </button>
                                </div>
                                <div style="font-size: 12px; opacity: 0.7; margin-top: 4px;">${timestamp}</div>
                                ${!isSent && msg.userId !== currentUser.id ? `
                                    <div class="message-options">
                                        <button class="options-btn" onclick="toggleMessageOptions(event, '${msg.userId}', '${displayName}')">â‹¯</button>
                                    </div>
                                ` : ''}
                                ${currentUser.role === 'admin' ? `
                                    <div style="position: absolute; top: 5px; right: 5px;">
                                        <button onclick="deleteMessage('${msg.id}')" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer;">Ø­Ø°Ù</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    container.scrollTop = container.scrollHeight;
                }, error => console.error("Error fetching messages: ", error));
        }

        // =================================================================
        // MESSAGE INTERACTIONS
        // =================================================================

        async function toggleLike(messageId) {
            if (!currentRoom || !currentUser) return;
            
            try {
                const messageRef = db.collection('rooms').doc(currentRoom.id).collection('messages').doc(messageId);
                const messageDoc = await messageRef.get();
                
                if (!messageDoc.exists) return;
                
                const messageData = messageDoc.data();
                const likes = messageData.likes || [];
                const userLiked = likes.includes(currentUser.id);
                
                if (userLiked) {
                    // Remove like
                    await messageRef.update({
                        likes: firebase.firestore.FieldValue.arrayRemove(currentUser.id),
                        likesCount: firebase.firestore.FieldValue.increment(-1)
                    });
                } else {
                    // Add like
                    await messageRef.update({
                        likes: firebase.firestore.FieldValue.arrayUnion(currentUser.id),
                        likesCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        function quoteMessage(content, userName) {
            const input = document.getElementById('messageInput');
            const quotedText = `"${content}" - ${userName}\n\n`;
            input.value = quotedText;
            input.focus();
        }

        async function deleteMessage(messageId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) return;
            
            try {
                await db.collection('rooms').doc(currentRoom.id).collection('messages').doc(messageId).delete();
                
                // Update room message count
                await db.collection('rooms').doc(currentRoom.id).update({
                    messageCount: firebase.firestore.FieldValue.increment(-1)
                });
                
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            }
        }

        // =================================================================
        // PROFILE MANAGEMENT
        // =================================================================

        function showProfile() {
            showUserProfile(currentUser.id);
        }

        async function showUserProfile(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const userData = userDoc.data();
                currentProfileUserId = userId;
                
                // Update profile modal
                document.getElementById('profileAvatar').src = userData.avatar;
                document.getElementById('profileName').textContent = userData.name;
                document.getElementById('profileEmail').textContent = userData.email;
                document.getElementById('profileRole').textContent = getRoleText(userData.role);
                document.getElementById('profileRole').className = `user-badge ${userData.role === 'admin' ? 'admin-badge' : userData.role === 'moderator' ? 'moderator-badge' : ''}`;
                document.getElementById('profileCoins').textContent = userData.coins || 0;
                document.getElementById('profileMessages').textContent = userData.messageCount || 0;
                document.getElementById('profileJoinDate').textContent = userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleDateString('ar-SA') : '-';
                
                // Show/hide edit fields based on whether it's current user
                const isCurrentUser = userId === currentUser.id;
                document.getElementById('profileBio').value = userData.bio || '';
                document.getElementById('profileNameEdit').value = userData.name;
                document.getElementById('profileBio').readOnly = !isCurrentUser;
                document.getElementById('profileNameEdit').readOnly = !isCurrentUser;
                
                // Show/hide private message button
                const privateMessageBtn = document.getElementById('privateMessageBtn');
                if (!isCurrentUser && currentUser.coins > 0) {
                    privateMessageBtn.style.display = 'block';
                    privateMessageBtn.disabled = false;
                } else if (!isCurrentUser && currentUser.coins === 0) {
                    privateMessageBtn.style.display = 'block';
                    privateMessageBtn.disabled = true;
                    privateMessageBtn.textContent = 'Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ÙƒÙˆÙŠÙ†Ø² Ù„ÙØªØ­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©';
                } else {
                    privateMessageBtn.style.display = 'none';
                }
                
                // Load avatar options
                loadAvatarOptions();
                
                document.getElementById('profileModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
            }
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
            currentProfileUserId = null;
        }

        function loadAvatarOptions() {
            const avatarOptions = [
                'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=100&h=100&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100&h=100&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=100&h=100&fit=crop&crop=face'
            ];
            
            const container = document.getElementById('avatarOptions');
            container.innerHTML = avatarOptions.map(avatar => `
                <img src="${avatar}" class="avatar-option" onclick="selectAvatar('${avatar}')">
            `).join('');
        }

        function selectAvatar(avatar) {
            selectedAvatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        async function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                return;
            }
            
            try {
                const storageRef = storage.ref(`avatars/${currentUser.id}/${Date.now()}`);
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                selectedAvatar = downloadURL;
                document.getElementById('profileAvatar').src = downloadURL;
                
                showNotification('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
            }
        }

        async function updateProfile() {
            if (currentProfileUserId !== currentUser.id) {
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¢Ø®Ø±');
                return;
            }
            
            const newName = document.getElementById('profileNameEdit').value.trim();
            const newBio = document.getElementById('profileBio').value.trim();
            
            if (!newName) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…');
                return;
            }
            
            try {
                const updates = {
                    name: newName,
                    bio: newBio
                };
                
                if (selectedAvatar) {
                    updates.avatar = selectedAvatar;
                }
                
                await db.collection('users').doc(currentUser.id).update(updates);
                currentUser = { ...currentUser, ...updates };
                updateHeader();
                closeProfileModal();
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
            }
        }

        // =================================================================
        // ADMIN PANEL
        // =================================================================

        function switchAdminTab(event, tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.remove('hidden');
        }

        function updateAdminStats() {
            db.collection('users').onSnapshot(snap => {
                document.getElementById('totalUsers').textContent = snap.size;
                document.getElementById('onlineUsers').textContent = snap.docs.filter(doc => doc.data().status === 'online').length;
            });
            db.collection('rooms').onSnapshot(snap => {
                document.getElementById('totalRooms').textContent = snap.size;
                let totalMessages = 0;
                snap.docs.forEach(doc => { totalMessages += (doc.data().messageCount || 0); });
                document.getElementById('totalMessages').textContent = totalMessages;
            });
        }

        function renderAdminUsers() {
            if (usersListener) usersListener();
            usersListener = db.collection('users').onSnapshot(snapshot => {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = snapshot.docs.map(doc => {
                    const user = doc.data();
                    const roleText = getRoleText(user.role);
                    const statusText = user.status === 'online' ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„';
                    const statusColor = user.status === 'online' ? '#10b981' : '#6b7280';
                    
                    return `
                        <tr>
                            <td><img src="${user.avatar}" class="avatar"></td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td><span class="user-badge ${user.role === 'admin' ? 'admin-badge' : user.role === 'moderator' ? 'moderator-badge' : ''}">${roleText}</span></td>
                            <td><span style="color: ${statusColor}; font-weight: 600;">${statusText}</span></td>
                            <td><span class="coins-display">${user.coins || 0} ğŸª™</span></td>
                            <td>
                                ${user.role !== 'admin' ? `<button class="action-btn btn-promote" onclick="promoteUser('${doc.id}')">ØªØ±Ù‚ÙŠØ©</button>` : ''}
                                ${user.role === 'moderator' ? `<button class="action-btn btn-demote" onclick="demoteUser('${doc.id}')">ØªØ®ÙÙŠØ¶</button>` : ''}
                                ${!user.banned ? `<button class="action-btn btn-ban" onclick="banUser('${doc.id}')">Ø­Ø¸Ø±</button>` : `<button class="action-btn btn-unban" onclick="unbanUser('${doc.id}')">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>`}
                            </td>
                        </tr>
                    `;
                }).join('');
            });
        }

        function renderAdminRooms() {
            db.collection('rooms').onSnapshot(snapshot => {
                const tbody = document.getElementById('roomsTableBody');
                tbody.innerHTML = snapshot.docs.map(doc => {
                    const room = { id: doc.id, ...doc.data() };
                    return `
                        <tr>
                            <td><img src="${room.image}" class="avatar"></td>
                            <td>${room.name}</td>
                            <td>${room.description}</td>
                            <td>${room.messageCount || 0}</td>
                            <td>${room.hidden ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</td>
                            <td>
                                <button class="action-btn btn-promote" onclick="showEditRoomModal('${room.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="action-btn btn-ban" onclick="deleteRoom('${room.id}')">Ø­Ø°Ù</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            });
        }

        function loadRoomSelectOptions() {
            db.collection('rooms').get().then(snapshot => {
                const select = document.getElementById('roomSelect');
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± ØºØ±ÙØ©</option>';
                snapshot.docs.forEach(doc => {
                    const room = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${room.name}</option>`;
                });
            });
        }

        function loadUserSelectOptions() {
            db.collection('users').get().then(snapshot => {
                const select = document.getElementById('userSelect');
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…</option>';
                snapshot.docs.forEach(doc => {
                    const user = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${user.name}</option>`;
                });
            });
        }

        async function loadRoomMessages() {
            const roomId = document.getElementById('roomSelect').value;
            const container = document.getElementById('roomMessagesContainer');
            
            if (!roomId) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Ø§Ø®ØªØ± ØºØ±ÙØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>';
                return;
            }
            
            try {
                const messagesSnapshot = await db.collection('rooms').doc(roomId).collection('messages')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                if (messagesSnapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©</p>';
                    return;
                }
                
                container.innerHTML = messagesSnapshot.docs.map(doc => {
                    const msg = { id: doc.id, ...doc.data() };
                    const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    
                    return `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <img src="${msg.userAvatar}" class="avatar" style="width: 24px; height: 24px;">
                                    <strong>${msg.userName}</strong>
                                    <span style="font-size: 12px; color: #6b7280;">${timestamp}</span>
                                </div>
                                <button onclick="deleteMessage('${msg.id}')" class="action-btn btn-ban" style="font-size: 10px; padding: 4px 8px;">Ø­Ø°Ù</button>
                            </div>
                            <div>${msg.content}</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading room messages:', error);
                container.innerHTML = '<p style="text-align: center; color: #ef4444;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>';
            }
        }

        // =================================================================
        // ADMIN ACTIONS
        // =================================================================

        async function promoteUser(userId) {
            try {
                await db.collection('users').doc(userId).update({ role: 'moderator' });
                showNotification('ØªÙ… ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error promoting user:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }

        async function demoteUser(userId) {
            try {
                await db.collection('users').doc(userId).update({ role: 'user' });
                showNotification('ØªÙ… ØªØ®ÙÙŠØ¶ Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error demoting user:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ®ÙÙŠØ¶ Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }

        async function banUser(userId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
            
            try {
                await db.collection('users').doc(userId).update({ banned: true });
                showNotification('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error banning user:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }

        async function unbanUser(userId) {
            try {
                await db.collection('users').doc(userId).update({ banned: false });
                showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error unbanning user:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }

        async function sendGlobalNotification() {
            const text = document.getElementById('notificationText').value.trim();
            if (!text) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡');
                return;
            }
            
            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await db.collection('notifications').add({
                    text: text,
                    type: 'global',
                    createdBy: currentUser.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ØªØ­Ø±Ùƒ
                showGlobalNotificationBar(text);
                
                document.getElementById('notificationText').value = '';
                showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†');
                
            } catch (error) {
                console.error('Error sending notification:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡');
            }
        }
        
        function showGlobalNotificationBar(message) {
            const notificationBar = document.getElementById('globalNotificationBar');
            const notificationTextElement = document.getElementById('notificationText');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ
            notificationTextElement.textContent = message;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ·
            notificationBar.classList.add('active');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
            setTimeout(() => {
                notificationBar.classList.remove('active');
            }, 5000);
        }

        async function sendCoins() {
            const userId = document.getElementById('userSelect').value;
            const amount = parseInt(document.getElementById('coinsAmount').value);
            
            if (!userId) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù…');
                return;
            }
            
            if (!amount || amount < 1) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„ÙƒÙˆÙŠÙ†Ø²');
                return;
            }
            
            try {
                // Update user coins
                await db.collection('users').doc(userId).update({
                    coins: firebase.firestore.FieldValue.increment(amount)
                });
                
                // Send notification to user
                await db.collection('notifications').add({
                    text: `Ù„Ù‚Ø¯ Ø§Ø³ØªÙ„Ù…Øª ${amount} ÙƒÙˆÙŠÙ†Ø² Ù…Ù† ${currentUser.name}`,
                    type: 'coins',
                    userId: userId,
                    amount: amount,
                    fromUserId: currentUser.id,
                    fromUserName: currentUser.name,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('userSelect').value = '';
                document.getElementById('coinsAmount').value = '';
                showNotification(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${amount} ÙƒÙˆÙŠÙ†Ø² Ø¨Ù†Ø¬Ø§Ø­`);
                
            } catch (error) {
                console.error('Error sending coins:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²');
            }
        }

        // =================================================================
        // ROOM MANAGEMENT
        // =================================================================

        function showAddRoomModal() {
            document.getElementById('addRoomModal').classList.add('active');
        }

        function closeAddRoomModal() {
            document.getElementById('addRoomModal').classList.remove('active');
        }

        async function addRoom() {
            const name = document.getElementById('newRoomName').value.trim();
            const description = document.getElementById('newRoomDesc').value.trim();
            const image = document.getElementById('newRoomImage').value.trim();
            const hidden = document.getElementById('newRoomHidden').checked;
            
            if (!name || !description) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }
            
            try {
                await db.collection('rooms').add({
                    name: name,
                    description: description,
                    image: image || 'https://images.unsplash.com/photo-1557804506-669a67965ba0?w=400&h=300&fit=crop',
                    messageCount: 0,
                    hidden: hidden,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Clear form
                document.getElementById('newRoomName').value = '';
                document.getElementById('newRoomDesc').value = '';
                document.getElementById('newRoomImage').value = '';
                document.getElementById('newRoomHidden').checked = false;
                
                closeAddRoomModal();
                showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('Error adding room:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØºØ±ÙØ©');
            }
        }

        async function showEditRoomModal(roomId) {
            try {
                const doc = await db.collection('rooms').doc(roomId).get();
                if (!doc.exists) return;
                
                const room = doc.data();
                document.getElementById('editRoomId').value = roomId;
                document.getElementById('editRoomName').value = room.name;
                document.getElementById('editRoomDesc').value = room.description;
                document.getElementById('editRoomImage').value = room.image;
                document.getElementById('editRoomHidden').checked = room.hidden || false;
                document.getElementById('editRoomModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading room data:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ©');
            }
        }

        function closeEditRoomModal() {
            document.getElementById('editRoomModal').classList.remove('active');
        }

        async function updateRoom() {
            const roomId = document.getElementById('editRoomId').value;
            const name = document.getElementById('editRoomName').value.trim();
            const description = document.getElementById('editRoomDesc').value.trim();
            const image = document.getElementById('editRoomImage').value.trim();
            const hidden = document.getElementById('editRoomHidden').checked;
            
            if (!name || !description) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }
            
            try {
                await db.collection('rooms').doc(roomId).update({
                    name: name,
                    description: description,
                    image: image,
                    hidden: hidden
                });
                
                closeEditRoomModal();
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('Error updating room:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±ÙØ©');
            }
        }

        async function deleteRoom(roomId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø£ÙŠØ¶Ø§Ù‹.')) return;
            
            try {
                // Delete all messages in the room
                const messagesSnapshot = await db.collection('rooms').doc(roomId).collection('messages').get();
                const batch = db.batch();
                messagesSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Delete the room
                await db.collection('rooms').doc(roomId).delete();
                
                showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©');
            }
        }

        // =================================================================
        // PRIVATE MESSAGES
        // =================================================================

        function showPrivateMessages() {
            document.getElementById('privateMessagesModal').classList.add('active');
            loadPrivateMessages();
        }

        function closePrivateMessagesModal() {
            document.getElementById('privateMessagesModal').classList.remove('active');
        }

        async function loadPrivateMessages() {
            try {
                const messagesSnapshot = await db.collection('privateMessages')
                    .where('participants', 'array-contains', currentUser.id)
                    .orderBy('lastMessageTime', 'desc')
                    .get();
                
                const container = document.getElementById('privateMessagesContainer');
                
                if (messagesSnapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø§ØµØ©</p>';
                    return;
                }
                
                container.innerHTML = messagesSnapshot.docs.map(doc => {
                    const conversation = doc.data();
                    const otherUserId = conversation.participants.find(id => id !== currentUser.id);
                    
                    return `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer;" onclick="openPrivateConversation('${doc.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${conversation.otherUserName}</strong>
                                <span style="font-size: 12px; color: #6b7280;">${conversation.lastMessageTime ? new Date(conversation.lastMessageTime.toDate()).toLocaleString('ar-SA') : ''}</span>
                            </div>
                            <div style="color: #6b7280; font-size: 14px; margin-top: 4px;">${conversation.lastMessage || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„'}</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading private messages:', error);
                document.getElementById('privateMessagesContainer').innerHTML = '<p style="text-align: center; color: #ef4444;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>';
            }
        }

        async function openPrivateMessage() {
            if (currentUser.coins < 1) {
                alert('Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ÙƒÙˆÙŠÙ†Ø² Ù„ÙØªØ­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©');
                return;
            }
            
            if (!currentProfileUserId || currentProfileUserId === currentUser.id) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                return;
            }
            
            try {
                // Deduct 1 coin from current user
                await db.collection('users').doc(currentUser.id).update({
                    coins: firebase.firestore.FieldValue.increment(-1)
                });
                
                currentUser.coins = Math.max(0, currentUser.coins - 1);
                updateHeader();
                
                // Create or find existing conversation
                const conversationId = [currentUser.id, currentProfileUserId].sort().join('_');
                
                const conversationRef = db.collection('privateMessages').doc(conversationId);
                const conversationDoc = await conversationRef.get();
                
                if (!conversationDoc.exists) {
                    // Create new conversation
                    const otherUserDoc = await db.collection('users').doc(currentProfileUserId).get();
                    const otherUser = otherUserDoc.data();
                    
                    await conversationRef.set({
                        participants: [currentUser.id, currentProfileUserId],
                        participantNames: {
                            [currentUser.id]: currentUser.name,
                            [currentProfileUserId]: otherUser.name
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                closeProfileModal();
                showPrivateMessages();
                showNotification('ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© (ØªÙ… Ø®ØµÙ… ÙƒÙˆÙŠÙ† ÙˆØ§Ø­Ø¯)');
                
            } catch (error) {
                console.error('Error opening private message:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©');
            }
        }

        // =================================================================
        // UTILITY FUNCTIONS
        // =================================================================

        function getRoleText(role) {
            switch (role) {
                case 'admin': return 'Ù…Ø¯ÙŠØ±';
                case 'moderator': return 'Ù…Ø´Ø±Ù';
                default: return 'Ø¹Ø¶Ùˆ';
            }
        }

        function showNotification(text, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = text;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showAdminNotification() {
            const container = document.getElementById('adminNotificationContainer');
            container.innerHTML = `
                <div class="admin-notification">
                    ğŸ”¥ Ø£Ù†Øª Ù…Ø¯ÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚! ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØºØ±Ù Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                </div>
            `;
        }

        // =================================================================
        // EMOJI PICKER
        // =================================================================

        function initializeEmojiPicker() {
            const emojis = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•'];
            
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = emojis.map(emoji => `
                <button class="emoji-btn" onclick="insertEmoji('${emoji}')">${emoji}</button>
            `).join('');
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('active');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            document.getElementById('emojiPicker').classList.remove('active');
        }

        // =================================================================
        // BLOCK AND REPORT SYSTEM
        // =================================================================
        
        function toggleMessageOptions(event, userId, userName) {
            event.stopPropagation();
            
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ø®ÙŠØ§Ø±Ø§Øª Ù…ÙØªÙˆØ­Ø©
            document.querySelectorAll('.options-menu').forEach(menu => menu.remove());
            
            const menu = document.createElement('div');
            menu.className = 'options-menu';
            menu.innerHTML = `
                <button onclick="blockUser('${userId}', '${userName}')">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                <button onclick="reportUser('${userId}', '${userName}')">Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
            `;
            
            event.target.parentElement.appendChild(menu);
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }
        
        async function blockUser(userId, userName) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± ${userName}ØŸ Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø±Ø¤ÙŠØ© Ø±Ø³Ø§Ø¦Ù„Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†.`)) return;
            
            try {
                await db.collection('users').doc(currentUser.id).update({
                    blockedUsers: firebase.firestore.FieldValue.arrayUnion(userId)
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ
                if (!currentUser.blockedUsers) currentUser.blockedUsers = [];
                currentUser.blockedUsers.push(userId);
                
                showNotification(`ØªÙ… Ø­Ø¸Ø± ${userName} Ø¨Ù†Ø¬Ø§Ø­`);
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¸ÙˆØ±
                renderMessages();
                
            } catch (error) {
                console.error('Error blocking user:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }
        
        async function reportUser(userId, userName) {
            const reason = prompt(`Ù„Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† ${userName}ØŸ`, '');
            if (!reason || !reason.trim()) return;
            
            try {
                await db.collection('reports').add({
                    reportedUserId: userId,
                    reportedUserName: userName,
                    reporterUserId: currentUser.id,
                    reporterUserName: currentUser.name,
                    reason: reason.trim(),
                    roomId: currentRoom.id,
                    roomName: currentRoom.name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                });
                
                showNotification(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¹Ù† ${userName} Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.`);
                
            } catch (error) {
                console.error('Error reporting user:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº');
            }
        }

        // =================================================================
        // EVENT LISTENERS
        // =================================================================

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // =================================================================
        // CONTACT ADMIN FUNCTION
        // =================================================================
        
        async function contactAdmin() {
            const message = prompt('Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©:');
            if (!message || !message.trim()) return;
            
            try {
                await db.collection('admin_messages').add({
                    message: message.trim(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userAvatar: currentUser.avatar,
                    roomId: currentRoom ? currentRoom.id : null,
                    roomName: currentRoom ? currentRoom.name : null,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'unread'
                });
                
                showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.');
                
            } catch (error) {
                console.error('Error sending message to admin:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            }
        }

        // =================================================================
        // ENHANCED PROFILE FUNCTIONS
        // =================================================================
        
        async function showProfile(userId = null) {
            const targetUserId = userId || currentUser.id;
            currentProfileUserId = targetUserId;
            
            try {
                const userDoc = await db.collection('users').doc(targetUserId).get();
                if (!userDoc.exists) {
                    alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const userData = userDoc.data();
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
                document.getElementById('profileAvatar').src = userData.avatar || 'https://via.placeholder.com/120';
                document.getElementById('profileName').textContent = userData.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ù… Ø§Ù„Ø¨Ù„Ø¯
                const countryFlag = document.getElementById('profileCountryFlag');
                const country = userData.country || 'ğŸŒ';
                countryFlag.textContent = country.split(' ')[0]; // Ø£Ø®Ø° Ø§Ù„Ø±Ù…Ø² ÙÙ‚Ø·
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                const statusElement = document.getElementById('profileStatus');
                const statusIndicator = document.getElementById('profileStatusIndicator');
                if (userData.status === 'online') {
                    statusElement.textContent = 'Ù…ØªÙˆØ§Ø¬Ø¯';
                    statusIndicator.className = 'status-indicator status-online';
                } else {
                    statusElement.textContent = 'ØºÙŠØ± Ù…ØªÙˆØ§Ø¬Ø¯';
                    statusIndicator.className = 'status-indicator status-offline';
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ø±ØªØ¨Ø©
                const roleElement = document.getElementById('profileRole');
                const roleText = getRoleText(userData.role);
                roleElement.textContent = roleText;
                roleElement.className = `profile-role-badge role-${userData.role || 'user'}`;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                document.getElementById('profileCoins').textContent = userData.coins || 0;
                document.getElementById('profileMessages').textContent = userData.messageCount || 0;
                
                // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                const joinDate = userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('profileJoinDate').textContent = joinDate;
                
                // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
                const birthDate = userData.birthDate ? new Date(userData.birthDate).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('profileBirthDate').textContent = birthDate;
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                if (targetUserId === currentUser.id) {
                    document.getElementById('profileBio').value = userData.bio || '';
                    document.getElementById('profileNameEdit').value = userData.name || '';
                    document.getElementById('profileCountry').value = userData.country || 'ğŸŒ';
                    document.getElementById('profileBirthDateEdit').value = userData.birthDate || '';
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ©
                    document.getElementById('privateMessageBtn').style.display = 'none';
                } else {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
                    document.getElementById('privateMessageBtn').style.display = 'block';
                    
                    // Ø¬Ø¹Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
                    document.getElementById('profileBio').value = userData.bio || 'Ù„Ù… ÙŠÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø°Ø© Ø¹Ù† Ù†ÙØ³Ù‡ Ø¨Ø¹Ø¯';
                    document.getElementById('profileBio').disabled = true;
                    document.getElementById('profileNameEdit').disabled = true;
                    document.getElementById('profileCountry').disabled = true;
                    document.getElementById('profileBirthDateEdit').disabled = true;
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„Ø±Ù…Ø²ÙŠØ©
                updateAvatarOptions();
                
                document.getElementById('profileModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
            }
        }
        
        async function updateProfile() {
            if (currentProfileUserId !== currentUser.id) {
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¢Ø®Ø±');
                return;
            }
            
            const newName = document.getElementById('profileNameEdit').value.trim();
            const newBio = document.getElementById('profileBio').value.trim();
            const newCountry = document.getElementById('profileCountry').value;
            const newBirthDate = document.getElementById('profileBirthDateEdit').value;
            
            if (!newName) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…');
                return;
            }
            
            try {
                const updates = {
                    name: newName,
                    bio: newBio,
                    country: newCountry
                };
                
                if (newBirthDate) {
                    updates.birthDate = newBirthDate;
                }
                
                if (selectedAvatar) {
                    updates.avatar = selectedAvatar;
                }
                
                await db.collection('users').doc(currentUser.id).update(updates);
                currentUser = { ...currentUser, ...updates };
                updateHeader();
                closeProfileModal();
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
            }
        }

        // Listen for notifications
        if (currentUser) {
            db.collection('notifications')
                .where('userId', '==', currentUser.id)
                .where('read', '==', false)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const notification = change.doc.data();
                            showNotification(notification.text, notification.type);
                            
                            // Mark as read
                            change.doc.ref.update({ read: true });
                        }
                    });
                });
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>
